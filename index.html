<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Solleciti Debiti - Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* macOS Style Design */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f7;
        }
        
        /* Effetto vetro macOS */
        .glass {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        /* Bottoni macOS style */
        .mac-button {
            background: linear-gradient(180deg, #fff 0%, #f0f0f0 100%);
            border: 1px solid rgba(0, 0, 0, 0.12);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease;
        }
        
        .mac-button:hover {
            background: linear-gradient(180deg, #f8f8f8 0%, #e8e8e8 100%);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .mac-button:active {
            background: linear-gradient(180deg, #e8e8e8 0%, #d8d8d8 100%);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15);
        }
        
        /* Input macOS style */
        .mac-input {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.15);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        
        .mac-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2), inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        /* Card con ombre macOS */
        .mac-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* Tooltip style */
        .tooltip {
            position: relative;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: auto;
            min-width: 120px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Animazioni fluide */
        * {
            transition: all 0.2s ease;
        }
        
        /* Scrollbar macOS style */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Badge style */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 10px;
            background: #FF3B30;
            color: white;
        }
        
        /* Select macOS style */
        .mac-select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const DebtManagementApp = () => {
          // Stati principali
          const [data, setData] = useState([]);
          const [filteredData, setFilteredData] = useState([]);
          const [searchTerm, setSearchTerm] = useState('');
          const [searchType, setSearchType] = useState('ragioneSociale');
          const [currentFile, setCurrentFile] = useState(null);
          const [copied, setCopied] = useState(false);
          const [selectedDebtor, setSelectedDebtor] = useState(null);
          
          // Stati per dati persistenti (legati a BDTI)
          const [persistentData, setPersistentData] = useState({});
          
          // Stati UI
          const [showAllNotes, setShowAllNotes] = useState(false);
          const [showDashboard, setShowDashboard] = useState(false);
          const [showNotifications, setShowNotifications] = useState(false);
          const [showCalendar, setShowCalendar] = useState(false);
          const [showHistory, setShowHistory] = useState(false);
          const [showPromises, setShowPromises] = useState(false);
          const [history, setHistory] = useState([]);
          const [selectedTemplate, setSelectedTemplate] = useState('primo');
          const [filterStatus, setFilterStatus] = useState('all');
          const [groupBy, setGroupBy] = useState('none'); // none, affiliato, teamManager
          
          // Stati per sincronizzazione
          const [autoSave, setAutoSave] = useState(true);
          const [lastSync, setLastSync] = useState(null);
          const [syncError, setSyncError] = useState(null);
          const [isSyncing, setIsSyncing] = useState(false);
          const [localDataCount, setLocalDataCount] = useState(0);
          
          // GitHub config
          const [githubToken, setGithubToken] = useState(localStorage.getItem('githubToken') || '');
          const [githubRepo, setGithubRepo] = useState(localStorage.getItem('githubRepo') || '');
          const [showGithubConfig, setShowGithubConfig] = useState(false);

          // Carica dati iniziali
          useEffect(() => {
            loadPersistentData();
            checkPromiseAlerts();
          }, []);

          // Aggiorna contatore dati locali
          useEffect(() => {
            const uniqueBdti = new Set(data.map(item => item.bdti));
            setLocalDataCount(uniqueBdti.size);
          }, [data]);

          // Auto-salvataggio
          useEffect(() => {
            if (autoSave && Object.keys(persistentData).length > 0) {
              const timer = setTimeout(() => {
                savePersistentData();
              }, 30000); // Ogni 30 secondi
              return () => clearTimeout(timer);
            }
          }, [persistentData, autoSave]);

          // Controlla alert promesse ogni minuto
          useEffect(() => {
            const interval = setInterval(() => {
              checkPromiseAlerts();
            }, 60000); // Ogni minuto
            return () => clearInterval(interval);
          }, [persistentData]);

          // Carica dati persistenti da localStorage
          const loadPersistentData = () => {
            try {
              const saved = localStorage.getItem('debtPersistentData');
              if (saved) {
                setPersistentData(JSON.parse(saved));
              }
            } catch (error) {
              console.error('Errore caricamento dati:', error);
            }
          };

          // Salva dati persistenti
          const savePersistentData = () => {
            try {
              localStorage.setItem('debtPersistentData', JSON.stringify(persistentData));
              localStorage.setItem('debtPersistentBackup', JSON.stringify({
                data: persistentData,
                timestamp: new Date().toISOString()
              }));
              addHistoryEvent('Salvataggio', 'Dati salvati localmente');
            } catch (error) {
              console.error('Errore salvataggio:', error);
            }
          };

          // Ottieni dati persistenti per BDTI
          const getPersistentDataForBDTI = (bdti) => {
            return persistentData[bdti] || {
              affiliato: '',
              note: '',
              stato: '',
              contatti: {},
              dataPromessa: null,
              fonte: ''
            };
          };

          // Aggiorna dati persistenti per BDTI
          const updatePersistentData = (bdti, field, value) => {
            setPersistentData(prev => ({
              ...prev,
              [bdti]: {
                ...getPersistentDataForBDTI(bdti),
                [field]: value,
                lastModified: new Date().toISOString()
              }
            }));
          };

          // Controlla alert promesse
          const checkPromiseAlerts = () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let alertPromises = [];
            
            Object.entries(persistentData).forEach(([bdti, data]) => {
              if (data.stato === 'promessa' && data.dataPromessa) {
                const promiseDate = new Date(data.dataPromessa);
                promiseDate.setHours(0, 0, 0, 0);
                
                const diffDays = Math.floor((today - promiseDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0) {
                  const clientData = filteredData.find(item => item.bdti === bdti);
                  if (clientData) {
                    alertPromises.push({
                      bdti,
                      ragioneSociale: clientData.ragioneSociale,
                      giorniScaduti: diffDays
                    });
                  }
                }
              }
            });
            
            if (alertPromises.length > 0 && !sessionStorage.getItem('promiseAlertShown')) {
              alert(`⚠️ ATTENZIONE: ${alertPromises.length} promesse scadute!\n\n` +
                    alertPromises.map(p => `${p.ragioneSociale} - scaduta da ${p.giorniScaduti} giorni`).join('\n'));
              sessionStorage.setItem('promiseAlertShown', 'true');
            }
            
            return alertPromises;
          };

          // Upload su GitHub
          const uploadToGitHub = async () => {
            if (!githubToken || !githubRepo) {
              setSyncError('Configura prima GitHub (token e repository)');
              setShowGithubConfig(true);
              return;
            }

            setIsSyncing(true);
            setSyncError(null);

            try {
              const [owner, repo] = githubRepo.split('/');
              const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/debt-data.json`, {
                method: 'PUT',
                headers: {
                  'Authorization': `token ${githubToken}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  message: `Update debt data - ${new Date().toLocaleString('it-IT')}`,
                  content: btoa(unescape(encodeURIComponent(JSON.stringify({
                    persistentData,
                    currentFile,
                    lastModified: new Date().toISOString()
                  }, null, 2)))),
                  sha: await getFileSha(owner, repo)
                })
              });

              if (response.ok) {
                setLastSync(new Date().toLocaleString('it-IT'));
                addHistoryEvent('Sync GitHub', 'Dati caricati su GitHub');
              } else {
                throw new Error('Errore upload GitHub');
              }
            } catch (error) {
              setSyncError('Errore upload. Verifica token e repository.');
              console.error('Errore sync:', error);
            } finally {
              setIsSyncing(false);
            }
          };

          // Scarica da GitHub
          const downloadFromGitHub = async () => {
            if (!githubToken || !githubRepo) {
              setSyncError('Configura prima GitHub');
              setShowGithubConfig(true);
              return;
            }

            if (!window.confirm('⚠️ Vuoi sovrascrivere i dati locali con quelli di GitHub?\n\nI tuoi dati attuali verranno sostituiti!')) {
              return;
            }

            setIsSyncing(true);
            setSyncError(null);

            try {
              // Prima fai backup
              savePersistentData();

              const [owner, repo] = githubRepo.split('/');
              const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/debt-data.json`, {
                headers: {
                  'Authorization': `token ${githubToken}`
                }
              });

              if (response.ok) {
                const data = await response.json();
                const content = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                
                setPersistentData(content.persistentData || {});
                setLastSync(new Date().toLocaleString('it-IT'));
                addHistoryEvent('Sync GitHub', 'Dati scaricati da GitHub');
                
                alert('✅ Dati scaricati con successo!');
                window.location.reload();
              } else {
                throw new Error('File non trovato su GitHub');
              }
            } catch (error) {
              setSyncError('Errore download. Verifica che il file esista su GitHub.');
              console.error('Errore sync:', error);
            } finally {
              setIsSyncing(false);
            }
          };

          // Ottieni SHA del file per GitHub
          const getFileSha = async (owner, repo) => {
            try {
              const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/debt-data.json`, {
                headers: {
                  'Authorization': `token ${githubToken}`
                }
              });
              if (response.ok) {
                const data = await response.json();
                return data.sha;
              }
            } catch (error) {
              return undefined;
            }
          };

          // Gestione upload file Excel
          const handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data);
              const worksheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
              
              const formattedData = [];
              for (let i = 2; i < jsonData.length; i++) {
                if (jsonData[i][0]) {
                  const bdti = String(jsonData[i][3] || '');
                  const persistentInfo = getPersistentDataForBDTI(bdti);
                  
                  formattedData.push({
                    nomeConsulente: jsonData[i][0] || '',
                    nomeAreaManager: jsonData[i][1] || '',
                    nomeTeamManager: jsonData[i][2] || '',
                    bdti: bdti,
                    ragioneSociale: jsonData[i][4] || '',
                    documento: jsonData[i][5] || '',
                    dataDocumento: jsonData[i][6] || '',
                    dataScadenza: jsonData[i][7] || '',
                    debito: parseFloat(jsonData[i][8]) || 0,
                    codPagamento: jsonData[i][9] || '',
                    noteExcel: jsonData[i][10] || '',
                    // Dati persistenti recuperati
                    affiliato: persistentInfo.affiliato,
                    note: persistentInfo.note,
                    stato: persistentInfo.stato,
                    contatti: persistentInfo.contatti,
                    dataPromessa: persistentInfo.dataPromessa,
                    fonte: persistentInfo.fonte
                  });
                }
              }
              
              setData(formattedData);
              setFilteredData(formattedData);
              setCurrentFile(file.name);
              savePersistentData();
              addHistoryEvent('File caricato', file.name);
              
              // Alert per promesse scadute
              checkPromiseAlerts();
            };
            reader.readAsArrayBuffer(file);
          };

          // Funzione di ricerca
          const handleSearch = () => {
            let filtered = data;

            if (searchTerm) {
              const searchLower = searchTerm.toLowerCase();
              filtered = filtered.filter(item => {
                const persistent = getPersistentDataForBDTI(item.bdti);
                switch (searchType) {
                  case 'bdti':
                    return item.bdti.toLowerCase().includes(searchLower);
                  case 'ragioneSociale':
                    return item.ragioneSociale.toLowerCase().includes(searchLower);
                  case 'teamManager':
                    return item.nomeTeamManager.toLowerCase().includes(searchLower);
                  case 'affiliato':
                    return persistent.affiliato.toLowerCase().includes(searchLower);
                  default:
                    return false;
                }
              });
            }

            setFilteredData(filtered);
          };

          useEffect(() => {
            handleSearch();
          }, [searchTerm, searchType, data]);

          // Applica filtri per stato
          const applyStatusFilter = (status) => {
            setFilterStatus(status);
            
            if (status === 'all') {
              setFilteredData(data);
            } else {
              const filteredBdti = Object.keys(persistentData).filter(
                bdti => persistentData[bdti].stato === status
              );
              setFilteredData(data.filter(item => filteredBdti.includes(item.bdti)));
            }
          };

          // Export Excel completo
          const exportToExcel = (onlySuspended = false) => {
            const exportData = [];
            
            Object.values(groupedData).forEach(group => {
              const persistent = getPersistentDataForBDTI(group.bdti);
              
              if (onlySuspended && persistent.stato !== 'sospeso') return;
              
              group.documents.forEach(doc => {
                exportData.push({
                  'Nome Consulente': doc.nomeConsulente,
                  'Nome Area Manager': doc.nomeAreaManager,
                  'Nome Team Manager': doc.nomeTeamManager,
                  'BDTI': doc.bdti,
                  'Ragione Sociale': doc.ragioneSociale,
                  'Affiliato': persistent.affiliato || '',
                  'Documento': doc.documento,
                  'Data Documento': doc.dataDocumento,
                  'Data Scadenza': doc.dataScadenza,
                  'Debito': doc.debito,
                  'Cod Pagamento': doc.codPagamento,
                  'Stato': persistent.stato || 'non definito',
                  'Data Promessa': persistent.dataPromessa || '',
                  'WhatsApp': persistent.contatti?.whatsapp ? 'SI' : 'NO',
                  'Mail': persistent.contatti?.mail ? 'SI' : 'NO',
                  'Voce': persistent.contatti?.voce ? 'SI' : 'NO',
                  'Note': persistent.note || '',
                  'Fonte': persistent.fonte || ''
                });
              });
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Debiti');
            
            const fileName = onlySuspended 
              ? `sospesi_${new Date().toISOString().slice(0,10)}.xlsx`
              : `debiti_completo_${new Date().toISOString().slice(0,10)}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
            addHistoryEvent('Export Excel', onlySuspended ? 'Solo sospesi' : 'Completo');
          };

          // Backup completo
          const createBackup = () => {
            const backupData = {
              persistentData,
              currentFile,
              history,
              timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `backup_debiti_completo_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            addHistoryEvent('Backup', 'Backup completo creato');
          };

          // Import backup
          const importBackup = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const imported = JSON.parse(e.target.result);
                
                if (imported.persistentData) {
                  setPersistentData(imported.persistentData);
                  savePersistentData();
                  alert('✅ Backup importato con successo!');
                  window.location.reload();
                } else {
                  alert('❌ Formato backup non valido');
                }
              } catch (error) {
                alert('❌ Errore nell\'importazione del backup');
              }
            };
            reader.readAsText(file);
            e.target.value = '';
          };

          // Ripristina backup
          const restoreBackup = () => {
            if (!window.confirm('⚠️ Ripristinare l\'ultimo backup?\n\nI dati attuali verranno persi!')) {
              return;
            }

            try {
              const backup = localStorage.getItem('debtPersistentBackup');
              if (backup) {
                const parsed = JSON.parse(backup);
                setPersistentData(parsed.data);
                alert('✅ Backup ripristinato!');
                window.location.reload();
              } else {
                alert('❌ Nessun backup trovato');
              }
            } catch (error) {
              alert('❌ Errore nel ripristino');
            }
          };

          // Genera testo WhatsApp
          const generateWhatsAppText = (debtor) => {
            const allDocuments = data.filter(item => item.bdti === debtor.bdti);
            const totalDebt = allDocuments.reduce((sum, item) => sum + (parseFloat(item.debito) || 0), 0);
            const persistent = getPersistentDataForBDTI(debtor.bdti);
            
            const templates = {
              primo: {
                name: 'Primo Sollecito',
                text: () => {
                  let text = `Gentile ${debtor.ragioneSociale},\n\n`;
                  text += `Le scriviamo per ricordarle che risultano scaduti i seguenti documenti:\n\n`;
                  allDocuments.forEach(doc => {
                    text += `• Doc. ${doc.documento} del ${doc.dataDocumento} - € ${doc.debito.toFixed(2)}\n`;
                  });
                  text += `\n*TOTALE: € ${totalDebt.toFixed(2)}*\n\n`;
                  text += `La preghiamo di regolarizzare la sua posizione quanto prima.\n`;
                  text += `Restiamo a disposizione per qualsiasi chiarimento.\n\n`;
                  text += `Cordiali saluti`;
                  return text;
                }
              },
              secondo: {
                name: 'Secondo Sollecito',
                text: () => {
                  let text = `Ciao l'amministrazione ti ha scritto in merito all'insoluto una mail con il dettaglio del dovuto\n\n`;
                  text += `*Cliente:* ${debtor.ragioneSociale}\n`;
                  text += `*Codice BDTI:* ${debtor.bdti}\n`;
                  if (persistent.affiliato) {
                    text += `*Affiliato:* ${persistent.affiliato}\n`;
                  }
                  text += `*Dettaglio documenti scaduti:*\n`;
                  allDocuments.forEach(doc => {
                    text += `• Doc. ${doc.documento} del ${doc.dataDocumento} - € ${doc.debito.toFixed(2)}\n`;
                  });
                  text += `\n*TOTALE DEBITO: € ${totalDebt.toFixed(2)}*\n\n`;
                  text += `mi fai sapere come regolarci per il saldo!! Se non mi dai riscontro a breve scatta la sospensione definitiva.`;
                  return text;
                }
              },
              conferma: {
                name: 'Conferma Pagamento',
                text: () => {
                  let text = `Gentile ${debtor.ragioneSociale},\n\n`;
                  text += `Abbiamo ricevuto il suo pagamento.\n`;
                  text += `La ringraziamo per aver regolarizzato la sua posizione.\n\n`;
                  text += `A presto!`;
                  return text;
                }
              }
            };
            
            let text = templates[selectedTemplate].text();
            
            // Non aggiungere più i metodi di contatto nel messaggio
            
            return text;
          };

          // Copia testo WhatsApp
          const copyToClipboard = (debtor) => {
            const text = generateWhatsAppText(debtor);
            navigator.clipboard.writeText(text).then(() => {
              setCopied(true);
              setSelectedDebtor(debtor.bdti);
              addHistoryEvent('Messaggio copiato', `BDTI ${debtor.bdti}`);
              setTimeout(() => {
                setCopied(false);
                setSelectedDebtor(null);
              }, 2000);
            });
          };

          // Aggiungi evento allo storico
          const addHistoryEvent = (action, details) => {
            const event = {
              timestamp: new Date().toLocaleString('it-IT'),
              action,
              details,
              user: 'Utente'
            };
            setHistory(prev => [event, ...prev].slice(0, 50));
          };

          // Calcola statistiche
          const getStats = () => {
            const totalDebt = data.reduce((sum, item) => sum + (parseFloat(item.debito) || 0), 0);
            
            const uniqueBdti = [...new Set(data.map(item => item.bdti))];
            const counts = {
              totale: uniqueBdti.length,
              pagato: 0,
              promessa: 0,
              sospeso: 0,
              attivi: 0
            };
            
            uniqueBdti.forEach(bdti => {
              const stato = persistentData[bdti]?.stato;
              if (stato === 'pagato') counts.pagato++;
              else if (stato === 'promessa') counts.promessa++;
              else if (stato === 'sospeso') counts.sospeso++;
              
              if (stato === 'pagato' || stato === 'promessa') counts.attivi++;
            });
            
            return { totalDebt, counts };
          };

          // Ottieni promesse scadute
          const getOverduePromises = () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            return Object.entries(persistentData)
              .filter(([bdti, data]) => {
                if (data.stato !== 'promessa' || !data.dataPromessa) return false;
                const promiseDate = new Date(data.dataPromessa);
                promiseDate.setHours(0, 0, 0, 0);
                return promiseDate < today;
              })
              .map(([bdti, data]) => {
                const clientData = filteredData.find(item => item.bdti === bdti);
                const promiseDate = new Date(data.dataPromessa);
                const diffDays = Math.floor((today - promiseDate) / (1000 * 60 * 60 * 24));
                
                return {
                  bdti,
                  ragioneSociale: clientData?.ragioneSociale || 'N/D',
                  dataPromessa: data.dataPromessa,
                  giorniScaduti: diffDays,
                  affiliato: data.affiliato
                };
              })
              .sort((a, b) => b.giorniScaduti - a.giorniScaduti);
          };

          // Dashboard Component
          const Dashboard = () => {
            const stats = getStats();
            const topDebtors = Object.values(groupedData)
              .sort((a, b) => b.totalDebt - a.totalDebt)
              .slice(0, 10);

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="mac-card max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-semibold flex items-center gap-2">
                      <span>📊</span>
                      Dashboard Statistiche
                    </h2>
                    <button 
                      onClick={() => setShowDashboard(false)} 
                      className="text-gray-500 hover:text-gray-700"
                    >
                      ✕
                    </button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div className="glass rounded-lg p-4">
                      <h3 className="text-sm text-gray-600 mb-1">Totale Debiti</h3>
                      <p className="text-2xl font-bold text-blue-600">
                        € {stats.totalDebt.toFixed(2)}
                      </p>
                    </div>
                    <div className="glass rounded-lg p-4">
                      <h3 className="text-sm text-gray-600 mb-1">Clienti Attivi</h3>
                      <p className="text-2xl font-bold text-green-600">
                        {stats.counts.attivi}
                      </p>
                    </div>
                    <div className="glass rounded-lg p-4">
                      <h3 className="text-sm text-gray-600 mb-1">Clienti Sospesi</h3>
                      <p className="text-2xl font-bold text-red-600">
                        {stats.counts.sospeso}
                      </p>
                    </div>
                  </div>

                  <div className="glass rounded-lg p-4">
                    <h3 className="font-semibold mb-4">Top 10 Debitori</h3>
                    <div className="space-y-2">
                      {topDebtors.map((debtor, idx) => (
                        <div key={debtor.bdti} className="flex justify-between items-center p-2 hover:bg-gray-50 rounded">
                          <span className="flex items-center gap-2">
                            <span className="text-gray-500 font-medium">{idx + 1}.</span>
                            {debtor.ragioneSociale}
                          </span>
                          <span className="font-semibold text-red-600">
                            € {debtor.totalDebt.toFixed(2)}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          // Vista Promesse
          const PromisesView = () => {
            const overduePromises = getOverduePromises();
            const upcomingPromises = Object.entries(persistentData)
              .filter(([bdti, data]) => {
                if (data.stato !== 'promessa' || !data.dataPromessa) return false;
                const promiseDate = new Date(data.dataPromessa);
                const today = new Date();
                return promiseDate >= today;
              })
              .map(([bdti, data]) => {
                const clientData = filteredData.find(item => item.bdti === bdti);
                return {
                  bdti,
                  ragioneSociale: clientData?.ragioneSociale || 'N/D',
                  dataPromessa: data.dataPromessa,
                  affiliato: data.affiliato
                };
              })
              .sort((a, b) => new Date(a.dataPromessa) - new Date(b.dataPromessa));

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="mac-card max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-semibold flex items-center gap-2">
                      <span>🤝</span>
                      Riepilogo Promesse
                    </h2>
                    <button 
                      onClick={() => setShowPromises(false)} 
                      className="text-gray-500 hover:text-gray-700"
                    >
                      ✕
                    </button>
                  </div>

                  {overduePromises.length > 0 && (
                    <div className="mb-6">
                      <h3 className="font-semibold text-red-600 mb-4 flex items-center gap-2">
                        <span>⚠️</span>
                        Promesse Scadute ({overduePromises.length})
                      </h3>
                      <div className="space-y-2">
                        {overduePromises.map((promise) => (
                          <div key={promise.bdti} className="glass rounded-lg p-3 border-l-4 border-red-500">
                            <div className="flex justify-between items-start">
                              <div>
                                <p className="font-semibold">{promise.ragioneSociale}</p>
                                <p className="text-sm text-gray-600">
                                  BDTI: {promise.bdti} {promise.affiliato && `• Affiliato: ${promise.affiliato}`}
                                </p>
                              </div>
                              <div className="text-right">
                                <p className="text-sm text-gray-600">
                                  Promessa: {new Date(promise.dataPromessa).toLocaleDateString('it-IT')}
                                </p>
                                <p className="text-sm font-semibold text-red-600">
                                  Scaduta da {promise.giorniScaduti} giorni
                                </p>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {upcomingPromises.length > 0 && (
                    <div>
                      <h3 className="font-semibold text-blue-600 mb-4 flex items-center gap-2">
                        <span>📅</span>
                        Promesse Future ({upcomingPromises.length})
                      </h3>
                      <div className="space-y-2">
                        {upcomingPromises.map((promise) => (
                          <div key={promise.bdti} className="glass rounded-lg p-3 border-l-4 border-blue-500">
                            <div className="flex justify-between items-start">
                              <div>
                                <p className="font-semibold">{promise.ragioneSociale}</p>
                                <p className="text-sm text-gray-600">
                                  BDTI: {promise.bdti} {promise.affiliato && `• Affiliato: ${promise.affiliato}`}
                                </p>
                              </div>
                              <div className="text-right">
                                <p className="text-sm font-semibold text-blue-600">
                                  {new Date(promise.dataPromessa).toLocaleDateString('it-IT')}
                                </p>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {overduePromises.length === 0 && upcomingPromises.length === 0 && (
                    <p className="text-center text-gray-500">Nessuna promessa registrata</p>
                  )}
                </div>
              </div>
            );
          };

          // Calendar View
          const CalendarView = () => {
            const overdueDebts = data.filter(item => {
              const dueDate = new Date(item.dataScadenza);
              const today = new Date();
              return dueDate < today;
            }).sort((a, b) => new Date(b.dataScadenza) - new Date(a.dataScadenza));

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="mac-card max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-semibold flex items-center gap-2">
                      <span>📅</span>
                      Scadenzario
                    </h2>
                    <button 
                      onClick={() => setShowCalendar(false)} 
                      className="text-gray-500 hover:text-gray-700"
                    >
                      ✕
                    </button>
                  </div>

                  <div className="space-y-2">
                    {overdueDebts.map((debt, idx) => {
                      const dueDate = new Date(debt.dataScadenza);
                      const today = new Date();
                      const diffDays = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                      
                      return (
                        <div key={idx} className="glass rounded-lg p-3">
                          <div className="flex justify-between items-center">
                            <div>
                              <p className="font-semibold">{debt.ragioneSociale}</p>
                              <p className="text-sm text-gray-600">
                                Doc. {debt.documento} - BDTI: {debt.bdti}
                              </p>
                            </div>
                            <div className="text-right">
                              <p className="font-bold text-red-600">€ {debt.debito.toFixed(2)}</p>
                              <p className="text-sm text-red-500">
                                Scaduto da {diffDays} giorni
                              </p>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            );
          };

          // History View
          const HistoryView = () => {
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="mac-card max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-semibold flex items-center gap-2">
                      <span>🕐</span>
                      Storico Azioni
                    </h2>
                    <button 
                      onClick={() => setShowHistory(false)} 
                      className="text-gray-500 hover:text-gray-700"
                    >
                      ✕
                    </button>
                  </div>

                  <div className="space-y-2">
                    {history.map((event, idx) => (
                      <div key={idx} className="glass rounded-lg p-3">
                        <div className="flex justify-between items-center">
                          <div>
                            <p className="font-semibold">{event.action}</p>
                            <p className="text-sm text-gray-600">{event.details}</p>
                          </div>
                          <div className="text-right">
                            <p className="text-sm text-gray-500">{event.timestamp}</p>
                            <p className="text-xs text-gray-400">{event.user}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                    {history.length === 0 && (
                      <p className="text-center text-gray-500">Nessuna azione registrata</p>
                    )}
                  </div>
                </div>
              </div>
            );
          };

          // GitHub Config Modal
          const GitHubConfigModal = () => {
            const [tempToken, setTempToken] = useState(githubToken);
            const [tempRepo, setTempRepo] = useState(githubRepo);

            const saveConfig = () => {
              setGithubToken(tempToken);
              setGithubRepo(tempRepo);
              localStorage.setItem('githubToken', tempToken);
              localStorage.setItem('githubRepo', tempRepo);
              setShowGithubConfig(false);
              addHistoryEvent('Configurazione', 'GitHub configurato');
            };

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="mac-card max-w-md w-full p-6">
                  <h2 className="text-xl font-semibold mb-4">Configura GitHub</h2>
                  
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        GitHub Token
                      </label>
                      <input
                        type="password"
                        value={tempToken}
                        onChange={(e) => setTempToken(e.target.value)}
                        className="w-full mac-input rounded-lg px-3 py-2"
                        placeholder="ghp_xxxxxxxxxxxx"
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        Crea su: github.com → Settings → Developer settings → Personal access tokens
                      </p>
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Repository (owner/nome)
                      </label>
                      <input
                        type="text"
                        value={tempRepo}
                        onChange={(e) => setTempRepo(e.target.value)}
                        className="w-full mac-input rounded-lg px-3 py-2"
                        placeholder="username/repo-name"
                      />
                    </div>
                  </div>
                  
                  <div className="flex gap-2 mt-6">
                    <button
                      onClick={saveConfig}
                      className="flex-1 mac-button rounded-lg px-4 py-2 font-medium"
                    >
                      Salva
                    </button>
                    <button
                      onClick={() => setShowGithubConfig(false)}
                      className="flex-1 mac-button rounded-lg px-4 py-2 font-medium"
                    >
                      Annulla
                    </button>
                  </div>
                </div>
              </div>
            );
          };

          // Raggruppa i dati
          const groupedData = filteredData.reduce((acc, item) => {
            if (!acc[item.bdti]) {
              acc[item.bdti] = {
                ...item,
                documents: [],
                totalDebt: 0
              };
            }
            acc[item.bdti].documents.push(item);
            acc[item.bdti].totalDebt += parseFloat(item.debito) || 0;
            return acc;
          }, {});

          // Raggruppa per affiliato o team manager se richiesto
          let displayData = groupedData;
          if (groupBy === 'affiliato') {
            displayData = {};
            Object.values(groupedData).forEach(group => {
              const persistent = getPersistentDataForBDTI(group.bdti);
              const key = persistent.affiliato || 'Senza Affiliato';
              if (!displayData[key]) {
                displayData[key] = {
                  isGroup: true,
                  groupName: key,
                  items: []
                };
              }
              displayData[key].items.push(group);
            });
          } else if (groupBy === 'teamManager') {
            displayData = {};
            Object.values(groupedData).forEach(group => {
              const key = group.nomeTeamManager || 'Senza Team Manager';
              if (!displayData[key]) {
                displayData[key] = {
                  isGroup: true,
                  groupName: key,
                  items: []
                };
              }
              displayData[key].items.push(group);
            });
          }

          const stats = getStats();
          const overduePromisesCount = getOverduePromises().length;

          return (
            <div className="min-h-screen bg-gray-50">
              <div className="max-w-7xl mx-auto p-4">
                {/* Header */}
                <div className="mac-card p-6 mb-6">
                  <div className="flex justify-between items-center mb-4">
                    <h1 className="text-3xl font-bold text-gray-800">
                      Gestione Solleciti Debiti
                    </h1>
                    <div className="flex items-center gap-4">
                      <div className="flex items-center gap-2">
                        <span className="text-sm text-gray-600">Autosalvataggio:</span>
                        <button
                          onClick={() => setAutoSave(!autoSave)}
                          className={`px-3 py-1 rounded-full text-sm font-medium ${
                            autoSave 
                              ? 'bg-green-500 text-white' 
                              : 'bg-gray-300 text-gray-700'
                          }`}
                        >
                          {autoSave ? 'ON' : 'OFF'}
                        </button>
                      </div>
                      <div className="flex gap-2">
                        <div className="tooltip">
                          <button
                            onClick={() => setShowDashboard(true)}
                            className="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                          >
                            <span>📊</span>
                          </button>
                          <span className="tooltiptext">Dashboard statistiche</span>
                        </div>
                        <div className="tooltip">
                          <button
                            onClick={() => setShowPromises(true)}
                            className="relative p-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600"
                          >
                            <span>🤝</span>
                            {overduePromisesCount > 0 && (
                              <span className="badge absolute -top-2 -right-2">
                                {overduePromisesCount}
                              </span>
                            )}
                          </button>
                          <span className="tooltiptext">Riepilogo promesse</span>
                        </div>
                        <div className="tooltip">
                          <button
                            onClick={() => setShowCalendar(true)}
                            className="p-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
                          >
                            <span>📅</span>
                          </button>
                          <span className="tooltiptext">Calendario scadenze</span>
                        </div>
                        <div className="tooltip">
                          <button
                            onClick={() => setShowHistory(true)}
                            className="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                          >
                            <span>🕐</span>
                          </button>
                          <span className="tooltiptext">Storico azioni</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* File Management e Sync */}
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center flex-wrap gap-2">
                        <div className="tooltip">
                          <label className="flex items-center gap-2 mac-button rounded-lg px-4 py-2 cursor-pointer">
                            <span>📤</span>
                            <span>Carica Excel</span>
                            <input
                              type="file"
                              accept=".xlsx,.xls"
                              onChange={handleFileUpload}
                              className="hidden"
                            />
                          </label>
                          <span className="tooltiptext">Carica file Excel</span>
                        </div>
                        
                        {currentFile && (
                          <>
                            <div className="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded-lg">
                              <span>📄</span>
                              <span className="text-sm">{currentFile}</span>
                            </div>
                            
                            <div className="tooltip">
                              <button
                                onClick={() => {
                                  if (window.confirm('⚠️ Eliminare tutti i dati?\n\nQuesta azione non può essere annullata!')) {
                                    setData([]);
                                    setFilteredData([]);
                                    setCurrentFile(null);
                                    setSelectedDebtor(null);
                                    addHistoryEvent('Dati eliminati', 'Tutti i dati del foglio');
                                  }
                                }}
                                className="flex items-center gap-2 mac-button rounded-lg px-4 py-2 text-red-600"
                              >
                                <span>🗑️</span>
                                <span>Elimina Dati</span>
                              </button>
                              <span className="tooltiptext">Elimina tutti i dati</span>
                            </div>
                          </>
                        )}
                        
                        {/* Pulsanti Sync */}
                        <div className="tooltip">
                          <button
                            onClick={uploadToGitHub}
                            disabled={isSyncing}
                            className="flex items-center gap-2 mac-button rounded-lg px-4 py-2 disabled:opacity-50"
                          >
                            <span>☁️</span>
                            <span>Carica</span>
                          </button>
                          <span className="tooltiptext">Carica su GitHub</span>
                        </div>
                        
                        <div className="tooltip">
                          <button
                            onClick={downloadFromGitHub}
                            disabled={isSyncing}
                            className="flex items-center gap-2 mac-button rounded-lg px-4 py-2 disabled:opacity-50"
                          >
                            <span>📥</span>
                            <span>Scarica</span>
                          </button>
                          <span className="tooltiptext">Scarica da GitHub</span>
                        </div>
                        
                        <div className="tooltip">
                          <button
                            onClick={createBackup}
                            className="flex items-center gap-2 mac-button rounded-lg px-4 py-2"
                          >
                            <span>🛡️</span>
                            <span>Backup</span>
                          </button>
                          <span className="tooltiptext">Crea backup locale</span>
                        </div>
                        
                        <div className="tooltip">
                          <label className="flex items-center gap-2 mac-button rounded-lg px-4 py-2 cursor-pointer">
                            <span>📄</span>
                            <span>Importa</span>
                            <input
                              type="file"
                              accept=".json"
                              onChange={importBackup}
                              className="hidden"
                            />
                          </label>
                          <span className="tooltiptext">Importa backup</span>
                        </div>
                        
                        <div className="tooltip">
                          <button
                            onClick={restoreBackup}
                            className="flex items-center gap-2 mac-button rounded-lg px-4 py-2"
                          >
                            <span>🔄</span>
                            <span>Ripristina</span>
                          </button>
                          <span className="tooltiptext">Ripristina ultimo backup</span>
                        </div>
                        
                        <div className="tooltip">
                          <button
                            onClick={() => setShowGithubConfig(true)}
                            className="flex items-center gap-2 mac-button rounded-lg px-4 py-2"
                          >
                            <span>⚙️</span>
                          </button>
                          <span className="tooltiptext">Configura GitHub</span>
                        </div>
                      </div>
                    </div>

                    {/* Info sincronizzazione */}
                    <div className="flex items-center justify-between text-sm text-gray-600">
                      <div className="flex items-center gap-4">
                        {lastSync && (
                          <span>Ultima sincronizzazione: {lastSync}</span>
                        )}
                        <span className="font-semibold">
                          Dati locali: {localDataCount} clienti
                        </span>
                      </div>
                      {syncError && (
                        <div className="flex items-center gap-2 text-red-600">
                          <span>⚠️</span>
                          <span>{syncError}</span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Filtri e Ricerca */}
                <div className="mac-card p-4 mb-6">
                  <div className="space-y-4">
                    {/* Filtri stato */}
                    <div className="flex items-center gap-4 flex-wrap">
                      <span className="font-semibold">Mostra:</span>
                      <div className="flex gap-2">
                        <button
                          onClick={() => applyStatusFilter('all')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            filterStatus === 'all' 
                              ? 'bg-blue-500 text-white' 
                              : 'mac-button'
                          }`}
                        >
                          Tutti ({stats.counts.totale})
                        </button>
                        <button
                          onClick={() => applyStatusFilter('pagato')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            filterStatus === 'pagato' 
                              ? 'bg-green-500 text-white' 
                              : 'mac-button text-green-600'
                          }`}
                        >
                          Pagati ({stats.counts.pagato})
                        </button>
                        <button
                          onClick={() => applyStatusFilter('promessa')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            filterStatus === 'promessa' 
                              ? 'bg-yellow-500 text-white' 
                              : 'mac-button text-yellow-600'
                          }`}
                        >
                          Promesse ({stats.counts.promessa})
                        </button>
                        <button
                          onClick={() => applyStatusFilter('sospeso')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            filterStatus === 'sospeso' 
                              ? 'bg-red-500 text-white' 
                              : 'mac-button text-red-600'
                          }`}
                        >
                          Sospesi ({stats.counts.sospeso})
                        </button>
                      </div>
                    </div>

                    {/* Raggruppamento */}
                    <div className="flex items-center gap-4 flex-wrap">
                      <span className="font-semibold">Raggruppa per:</span>
                      <div className="flex gap-2">
                        <button
                          onClick={() => setGroupBy('none')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            groupBy === 'none' 
                              ? 'bg-gray-600 text-white' 
                              : 'mac-button'
                          }`}
                        >
                          Nessuno
                        </button>
                        <button
                          onClick={() => setGroupBy('affiliato')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            groupBy === 'affiliato' 
                              ? 'bg-purple-600 text-white' 
                              : 'mac-button'
                          }`}
                        >
                          Affiliato
                        </button>
                        <button
                          onClick={() => setGroupBy('teamManager')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            groupBy === 'teamManager' 
                              ? 'bg-indigo-600 text-white' 
                              : 'mac-button'
                          }`}
                        >
                          Team Manager
                        </button>
                      </div>
                    </div>

                    {/* Barra di ricerca */}
                    <div className="flex gap-4 flex-wrap">
                      <select
                        value={searchType}
                        onChange={(e) => setSearchType(e.target.value)}
                        className="mac-input mac-select rounded-lg px-4 py-2"
                      >
                        <option value="ragioneSociale">Ragione Sociale</option>
                        <option value="bdti">BDTI</option>
                        <option value="teamManager">Team Manager</option>
                        <option value="affiliato">Affiliato</option>
                      </select>
                      
                      <div className="flex-1 relative min-w-[200px]">
                        <input
                          type="text"
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                          placeholder="Cerca..."
                          className="w-full mac-input rounded-lg px-4 py-2 pr-10"
                        />
                        <span className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                          🔍
                        </span>
                      </div>

                      <select
                        value={selectedTemplate}
                        onChange={(e) => setSelectedTemplate(e.target.value)}
                        className="mac-input mac-select rounded-lg px-4 py-2"
                      >
                        <option value="primo">Primo Sollecito</option>
                        <option value="secondo">Secondo Sollecito</option>
                        <option value="conferma">Conferma Pagamento</option>
                      </select>

                      {/* Export buttons */}
                      {data.length > 0 && (
                        <div className="flex gap-2">
                          <div className="tooltip">
                            <button
                              onClick={() => exportToExcel(false)}
                              className="flex items-center gap-2 mac-button rounded-lg px-4 py-2"
                            >
                              <span>📥</span>
                              <span>Excel</span>
                            </button>
                            <span className="tooltiptext">Export Excel completo</span>
                          </div>
                          <div className="tooltip">
                            <button
                              onClick={() => exportToExcel(true)}
                              className="flex items-center gap-2 mac-button rounded-lg px-4 py-2"
                            >
                              <span>📥</span>
                              <span>Sospesi</span>
                            </button>
                            <span className="tooltiptext">Export solo sospesi</span>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Archivio Note */}
                {showAllNotes && (
                  <div className="mac-card p-6 mb-6">
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-semibold">📝 Archivio Note</h2>
                      <button
                        onClick={() => setShowAllNotes(false)}
                        className="text-gray-500 hover:text-gray-700"
                      >
                        ✕
                      </button>
                    </div>
                    <div className="space-y-3">
                      {Object.entries(persistentData)
                        .filter(([_, data]) => data.note)
                        .map(([bdti, data]) => {
                          const clientData = filteredData.find(item => item.bdti === bdti);
                          return (
                            <div key={bdti} className="glass rounded-lg p-4">
                              <div className="flex justify-between items-start mb-2">
                                <div>
                                  <span className="font-semibold">BDTI: {bdti}</span>
                                  {clientData && (
                                    <span className="ml-2 text-sm text-gray-600">
                                      - {clientData.ragioneSociale}
                                    </span>
                                  )}
                                  {data.affiliato && (
                                    <span className="ml-2 text-sm text-purple-600">
                                      • {data.affiliato}
                                    </span>
                                  )}
                                </div>
                                <span className="text-xs text-gray-500">
                                  {new Date(data.lastModified).toLocaleString('it-IT')}
                                </span>
                              </div>
                              <p className="text-gray-700 whitespace-pre-wrap">{data.note}</p>
                            </div>
                          );
                        })}
                    </div>
                  </div>
                )}

                {/* Results */}
                {Object.keys(displayData).length > 0 ? (
                  <div className="space-y-4">
                    {/* Visualizzazione raggruppata */}
                    {groupBy !== 'none' ? (
                      Object.entries(displayData).map(([groupKey, groupData]) => (
                        <div key={groupKey} className="space-y-4">
                          <h3 className="text-lg font-semibold text-gray-700 bg-gray-100 px-4 py-2 rounded-lg">
                            {groupData.groupName} ({groupData.items.length})
                          </h3>
                          {groupData.items.map((group) => (
                            <DebtorCard 
                              key={group.bdti} 
                              group={group} 
                              persistentData={persistentData}
                              getPersistentDataForBDTI={getPersistentDataForBDTI}
                              updatePersistentData={updatePersistentData}
                              handleStateChange={(bdti, state) => {
                                updatePersistentData(bdti, 'stato', state);
                                if (state !== 'promessa') {
                                  updatePersistentData(bdti, 'dataPromessa', null);
                                }
                                savePersistentData();
                              }}
                              handleContactMethodChange={(bdti, method, checked) => {
                                const current = getPersistentDataForBDTI(bdti);
                                updatePersistentData(bdti, 'contatti', {
                                  ...current.contatti,
                                  [method]: checked
                                });
                              }}
                              copyToClipboard={copyToClipboard}
                              selectedDebtor={selectedDebtor}
                              copied={copied}
                            />
                          ))}
                        </div>
                      ))
                    ) : (
                      // Visualizzazione normale
                      Object.values(displayData).map((group) => (
                        <DebtorCard 
                          key={group.bdti} 
                          group={group} 
                          persistentData={persistentData}
                          getPersistentDataForBDTI={getPersistentDataForBDTI}
                          updatePersistentData={updatePersistentData}
                          handleStateChange={(bdti, state) => {
                            updatePersistentData(bdti, 'stato', state);
                            if (state !== 'promessa') {
                              updatePersistentData(bdti, 'dataPromessa', null);
                            }
                            savePersistentData();
                          }}
                          handleContactMethodChange={(bdti, method, checked) => {
                            const current = getPersistentDataForBDTI(bdti);
                            updatePersistentData(bdti, 'contatti', {
                              ...current.contatti,
                              [method]: checked
                            });
                          }}
                          copyToClipboard={copyToClipboard}
                          selectedDebtor={selectedDebtor}
                          copied={copied}
                        />
                      ))
                    )}
                  </div>
                ) : (
                  <div className="mac-card p-12 text-center">
                    <p className="text-gray-500 text-lg">
                      {data.length === 0 
                        ? 'Carica un file Excel per iniziare'
                        : 'Nessun risultato trovato'}
                    </p>
                  </div>
                )}

                {/* Link archivio */}
                {!showAllNotes && Object.keys(persistentData).some(bdti => persistentData[bdti].note) && (
                  <div className="text-center mt-6">
                    <button
                      onClick={() => setShowAllNotes(true)}
                      className="text-blue-600 hover:text-blue-800 underline"
                    >
                      Vedi archivio note ({Object.keys(persistentData).filter(bdti => persistentData[bdti].note).length})
                    </button>
                  </div>
                )}
              </div>

              {/* Modals */}
              {showDashboard && <Dashboard />}
              {showPromises && <PromisesView />}
              {showCalendar && <CalendarView />}
              {showHistory && <HistoryView />}
              {showGithubConfig && <GitHubConfigModal />}
            </div>
          );
        };

        // Componente Card Debitore
        const DebtorCard = ({ 
          group, 
          persistentData,
          getPersistentDataForBDTI,
          updatePersistentData,
          handleStateChange,
          handleContactMethodChange,
          copyToClipboard,
          selectedDebtor,
          copied
        }) => {
          const persistent = getPersistentDataForBDTI(group.bdti);
          const state = persistent.stato;
          
          const stateColors = {
            pagato: 'border-green-500 bg-green-50',
            promessa: 'border-yellow-500 bg-yellow-50',
            sospeso: 'border-red-500 bg-red-50'
          };
          
          return (
            <div className={`mac-card p-6 border-2 ${stateColors[state] || 'border-gray-200'}`}>
              <div className="flex justify-between items-start mb-4">
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-2">
                    <h2 className="text-xl font-semibold text-gray-800">
                      {group.ragioneSociale}
                    </h2>
                    {persistent.note && (
                      <span title="Nota presente">📝</span>
                    )}
                  </div>
                  <div className="space-y-1 text-sm text-gray-600">
                    <p>BDTI: {group.bdti}</p>
                    <p>Team Manager: {group.nomeTeamManager}</p>
                    <div className="flex items-center gap-2">
                      <span>Affiliato:</span>
                      <input
                        type="text"
                        value={persistent.affiliato || ''}
                        onChange={(e) => updatePersistentData(group.bdti, 'affiliato', e.target.value)}
                        placeholder="Inserisci affiliato..."
                        className="mac-input rounded px-2 py-1 text-sm"
                      />
                    </div>
                  </div>
                </div>
                
                <div className="text-right">
                  <p className="text-2xl font-bold text-red-600">
                    € {group.totalDebt.toFixed(2)}
                  </p>
                  
                  {/* Pulsanti per stato */}
                  <div className="mt-3 flex gap-1">
                    <button
                      onClick={() => {
                        const newState = state === 'pagato' ? '' : 'pagato';
                        handleStateChange(group.bdti, newState);
                      }}
                      className={`flex-1 px-2 py-2 rounded-lg text-xs font-bold transition-all ${
                        state === 'pagato'
                          ? 'bg-green-500 text-white border-2 border-green-600 shadow-md'
                          : 'bg-white text-green-600 border border-green-500 hover:bg-green-50'
                      }`}
                    >
                      ATTIVO PAGATO
                    </button>
                    
                    <button
                      onClick={() => {
                        const newState = state === 'promessa' ? '' : 'promessa';
                        handleStateChange(group.bdti, newState);
                      }}
                      className={`flex-1 px-2 py-2 rounded-lg text-xs font-bold transition-all ${
                        state === 'promessa'
                          ? 'bg-yellow-500 text-white border-2 border-yellow-600 shadow-md'
                          : 'bg-white text-yellow-600 border border-yellow-500 hover:bg-yellow-50'
                      }`}
                    >
                      ATTIVO PROMESSA
                    </button>
                    
                    <button
                      onClick={() => {
                        const newState = state === 'sospeso' ? '' : 'sospeso';
                        handleStateChange(group.bdti, newState);
                      }}
                      className={`flex-1 px-2 py-2 rounded-lg text-xs font-bold transition-all ${
                        state === 'sospeso'
                          ? 'bg-red-500 text-white border-2 border-red-600 shadow-md'
                          : 'bg-white text-red-600 border border-red-500 hover:bg-red-50'
                      }`}
                    >
                      SOSPESO
                    </button>
                  </div>
                  
                  {state === 'promessa' && (
                    <div className="mt-2">
                      <input
                        type="date"
                        value={persistent.dataPromessa || ''}
                        onChange={(e) => updatePersistentData(group.bdti, 'dataPromessa', e.target.value)}
                        className="mac-input rounded px-2 py-1 text-sm w-full"
                        min={new Date().toISOString().split('T')[0]}
                      />
                    </div>
                  )}
                  
                  <button
                    onClick={() => copyToClipboard(group)}
                    className={`mt-2 flex items-center gap-2 px-4 py-2 rounded-lg w-full justify-center ${
                      selectedDebtor === group.bdti && copied
                        ? 'bg-green-500 text-white'
                        : 'mac-button'
                    }`}
                  >
                    {selectedDebtor === group.bdti && copied ? (
                      <>
                        <span>✅</span>
                        <span>Copiato!</span>
                      </>
                    ) : (
                      <>
                        <span>📋</span>
                        <span>Copia WhatsApp</span>
                      </>
                    )}
                  </button>
                </div>
              </div>
              
              <div className="border-t pt-4">
                <h3 className="font-semibold text-gray-700 mb-2">Documenti:</h3>
                <div className="space-y-1 text-sm">
                  {group.documents.map((doc, idx) => (
                    <div key={idx} className="flex justify-between text-gray-600">
                      <span>Doc. {doc.documento} del {doc.dataDocumento}</span>
                      <span className="font-medium">€ {doc.debito.toFixed(2)}</span>
                    </div>
                  ))}
                </div>
                
                <div className="mt-4">
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-semibold text-gray-700">Note / Risposta cliente:</h3>
                    <div className="flex items-center gap-3">
                      <label className="flex items-center gap-1 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={persistent.contatti?.whatsapp || false}
                          onChange={(e) => handleContactMethodChange(group.bdti, 'whatsapp', e.target.checked)}
                          className="rounded"
                        />
                        <span>💬</span>
                        <span className="text-sm">WhatsApp</span>
                      </label>
                      <label className="flex items-center gap-1 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={persistent.contatti?.mail || false}
                          onChange={(e) => handleContactMethodChange(group.bdti, 'mail', e.target.checked)}
                          className="rounded"
                        />
                        <span>✉️</span>
                        <span className="text-sm">Mail</span>
                      </label>
                      <label className="flex items-center gap-1 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={persistent.contatti?.voce || false}
                          onChange={(e) => handleContactMethodChange(group.bdti, 'voce', e.target.checked)}
                          className="rounded"
                        />
                        <span>📞</span>
                        <span className="text-sm">Voce</span>
                      </label>
                    </div>
                  </div>
                  <textarea
                    value={persistent.note || ''}
                    onChange={(e) => updatePersistentData(group.bdti, 'note', e.target.value)}
                    placeholder="Inserisci qui la risposta del cliente..."
                    className="w-full mac-input rounded-lg p-3 resize-none"
                    rows="3"
                  />
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DebtManagementApp />);
    </script>
</body>
</html>
