<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GestDebit Pro - Firebase Edition</title>
    
    <!-- PWA Meta Tags per iPad -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GestDebit">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f5f5f7">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Manifest per PWA -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR2VzdERlYml0IFBybyIsInNob3J0X25hbWUiOiJHZXN0RGViaXQiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsIm9yaWVudGF0aW9uIjoicG9ydHJhaXQiLCJzdGFydF91cmwiOiIuIiwidGhlbWVfY29sb3IiOiIjZjVmNWY3IiwiYmFja2dyb3VuZF9jb2xvciI6IiNmNWY1ZjcifQ==">
    
    <!-- Icona per Home Screen -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiMwMDdBRkYiLz4KPHBhdGggZD0iTTEyMCA2MEg2MEM1NC40NzcyIDYwIDUwIDY0LjQ3NzIgNTAgNzBWMTEwQzUwIDExNS41MjMgNTQuNDc3MiAxMjAgNjAgMTIwSDEyMEMxMjUuNTIzIDEyMCAxMzAgMTE1LjUyMyAxMzAgMTEwVjcwQzEzMCA2NC40NzcyIDEyNS41MjMgNjAgMTIwIDYwWiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI2IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTcwIDgwSDExMCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPHBhdGggZD0iTTcwIDkwSDEwMCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPHBhdGggZD0iTTcwIDEwMEg5NSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+">
    
    <!-- React e dipendenze -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK v10 -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Altri script -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* macOS Style Design */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f7;
        }
        
        /* Effetto vetro macOS */
        .glass {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        /* Bottoni macOS style */
        .mac-button {
            background: linear-gradient(180deg, #fff 0%, #f0f0f0 100%);
            border: 1px solid rgba(0, 0, 0, 0.12);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease;
        }
        
        .mac-button:hover {
            background: linear-gradient(180deg, #f8f8f8 0%, #e8e8e8 100%);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .mac-button:active {
            background: linear-gradient(180deg, #e8e8e8 0%, #d8d8d8 100%);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15);
        }
        
        /* Input macOS style */
        .mac-input {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.15);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        
        .mac-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2), inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        /* Card con ombre macOS */
        .mac-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* Tooltip style */
        .tooltip {
            position: relative;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: auto;
            min-width: 120px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Animazioni fluide */
        * {
            transition: all 0.2s ease;
        }
        
        /* Scrollbar macOS style */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Badge style */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 10px;
            background: #FF3B30;
            color: white;
        }
        
        /* Select macOS style */
        .mac-select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px;
        }
        
        /* Ottimizzazioni per iPad */
        @media (max-width: 1024px) {
            body {
                -webkit-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
            }
            
            input, textarea {
                -webkit-user-select: text;
                user-select: text;
                font-size: 16px; /* Previene zoom su focus */
            }
            
            .mac-card {
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            /* Pulsanti più grandi su touch */
            button {
                min-height: 44px;
            }
            
            /* Scrolling più fluido */
            .overflow-y-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Nascondi scrollbar su iPad per look più pulito */
        @supports (-webkit-touch-callout: none) {
            ::-webkit-scrollbar {
                display: none;
            }
        }
        
        /* Previeni bounce scroll su iOS */
        html, body {
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        #root {
            height: 100%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Configurazione Firebase (le tue credenziali)
        const firebaseConfig = {
            apiKey: "AIzaSyA-d-P-4Aq-v3aeq7DEMYoGzwwmMuJLASY",
            authDomain: "gestdebit.firebaseapp.com",
            projectId: "gestdebit",
            storageBucket: "gestdebit.firebasestorage.app",
            messagingSenderId: "424705172159",
            appId: "1:424705172159:web:92d2762f9690934d451c0a"
        };

        // Inizializza Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const { useState, useEffect, useRef } = React;
        
        // Componente Login
        const LoginForm = ({ onClose }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            
            const handleSubmit = async () => {
                if (!email || !password) return;
                
                setIsLoading(true);
                setError('');
                
                try {
                    if (isRegistering) {
                        await auth.createUserWithEmailAndPassword(email, password);
                    } else {
                        await auth.signInWithEmailAndPassword(email, password);
                    }
                    onClose();
                } catch (error) {
                    setError(
                        error.code === 'auth/user-not-found' ? 'Utente non trovato' :
                        error.code === 'auth/wrong-password' ? 'Password errata' :
                        error.code === 'auth/email-already-in-use' ? 'Email già registrata' :
                        error.code === 'auth/weak-password' ? 'Password troppo debole (min 6 caratteri)' :
                        error.code === 'auth/invalid-email' ? 'Email non valida' :
                        'Errore di accesso'
                    );
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="mac-card max-w-md w-full p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-semibold flex items-center gap-2">
                                <span>🔥</span>
                                {isRegistering ? 'Registrati' : 'Accedi'} con Firebase
                            </h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                ✕
                            </button>
                        </div>
                        
                        {error && (
                            <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                                {error}
                            </div>
                        )}
                        
                        <div className="space-y-4">
                            <input
                                type="email"
                                placeholder="Email"
                                className="w-full mac-input rounded-lg px-3 py-2"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
                            />
                            <input
                                type="password"
                                placeholder="Password (min 6 caratteri)"
                                className="w-full mac-input rounded-lg px-3 py-2"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
                            />
                            
                            <button
                                onClick={handleSubmit}
                                disabled={isLoading || !email || !password}
                                className="w-full bg-blue-500 text-white rounded-lg py-3 font-medium disabled:opacity-50 hover:bg-blue-600"
                            >
                                {isLoading ? 'Elaborazione...' : (isRegistering ? 'Registrati' : 'Accedi')}
                            </button>
                            
                            <button
                                onClick={() => setIsRegistering(!isRegistering)}
                                className="w-full text-blue-600 hover:text-blue-800 text-sm"
                            >
                                {isRegistering ? 'Hai già un account? Accedi' : 'Non hai un account? Registrati'}
                            </button>
                        </div>
                        
                        <p className="mt-4 text-xs text-gray-500 text-center">
                            I tuoi dati saranno sincronizzati automaticamente su tutti i dispositivi
                        </p>
                    </div>
                </div>
            );
        };
        
        // App principale
        const DebtManagementApp = () => {
          // Rileva se siamo in modalità standalone
          const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
          
          // Stati principali
          const [data, setData] = useState([]);
          const [filteredData, setFilteredData] = useState([]);
          const [searchTerm, setSearchTerm] = useState('');
          const [searchType, setSearchType] = useState('ragioneSociale');
          const [currentFile, setCurrentFile] = useState(null);
          const [copied, setCopied] = useState(false);
          const [selectedDebtor, setSelectedDebtor] = useState(null);
          
          // Stati per dati persistenti
          const [persistentData, setPersistentData] = useState({});
          
          // Stati UI
          const [showAllNotes, setShowAllNotes] = useState(false);
          const [showDashboard, setShowDashboard] = useState(false);
          const [showNotifications, setShowNotifications] = useState(false);
          const [showCalendar, setShowCalendar] = useState(false);
          const [showHistory, setShowHistory] = useState(false);
          const [showPromises, setShowPromises] = useState(false);
          const [history, setHistory] = useState([]);
          const [selectedTemplate, setSelectedTemplate] = useState('primo');
          const [filterStatus, setFilterStatus] = useState('all');
          const [groupBy, setGroupBy] = useState('none');
          
          // Stati Firebase
          const [user, setUser] = useState(null);
          const [showLogin, setShowLogin] = useState(false);
          const [isOnline, setIsOnline] = useState(navigator.onLine);
          const [isSyncing, setIsSyncing] = useState(false);
          const [lastSync, setLastSync] = useState(null);
          const [syncError, setSyncError] = useState(null);
          const [autoSave, setAutoSave] = useState(true);
          const [localDataCount, setLocalDataCount] = useState(0);

          // Previeni pull-to-refresh su iOS
          useEffect(() => {
            let lastY = 0;
            
            const preventPullToRefresh = (e) => {
              const scrollY = window.pageYOffset || document.body.scrollTop || document.documentElement.scrollTop;
              
              lastY = lastY || e.touches[0].clientY;
              const y = e.touches[0].clientY;
              const direction = y > lastY ? 'down' : 'up';
              
              if (scrollY === 0 && direction === 'down' && e.cancelable) {
                e.preventDefault();
              }
              
              lastY = y;
            };
            
            document.addEventListener('touchmove', preventPullToRefresh, { passive: false });
            
            return () => {
              document.removeEventListener('touchmove', preventPullToRefresh);
            };
          }, []);

          // Monitora auth Firebase
          useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged((user) => {
              setUser(user);
              if (user) {
                console.log('Utente autenticato:', user.email);
                loadFromFirebase();
              } else {
                console.log('Utente non autenticato');
                // Carica dati locali se non autenticato
                loadLocalData();
              }
            });
            
            return () => unsubscribe();
          }, []);

          // Monitora connessione
          useEffect(() => {
            const handleOnline = () => setIsOnline(true);
            const handleOffline = () => setIsOnline(false);
            
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            return () => {
              window.removeEventListener('online', handleOnline);
              window.removeEventListener('offline', handleOffline);
            };
          }, []);

          // Carica dati iniziali
          useEffect(() => {
            checkPromiseAlerts();
          }, []);

          // Aggiorna contatore dati locali
          useEffect(() => {
            const uniqueBdti = new Set(data.map(item => item.bdti));
            setLocalDataCount(uniqueBdti.size);
          }, [data]);

          // Auto-salvataggio Firebase
          useEffect(() => {
            if (autoSave && user && isOnline && (Object.keys(persistentData).length > 0 || data.length > 0)) {
              const timer = setTimeout(() => {
                saveToFirebase();
              }, 5000); // Salva ogni 5 secondi
              return () => clearTimeout(timer);
            }
          }, [persistentData, data, user, isOnline, autoSave]);

          // Controlla alert promesse ogni minuto
          useEffect(() => {
            const interval = setInterval(() => {
              checkPromiseAlerts();
            }, 60000);
            return () => clearInterval(interval);
          }, [persistentData]);

          // Salva su Firebase
          const saveToFirebase = async () => {
            if (!user || !isOnline) return;
            
            setIsSyncing(true);
            setSyncError(null);
            
            try {
              await db.collection('users').doc(user.uid).set({
                persistentData,
                excelData: data,
                currentFile,
                history: history.slice(0, 100), // Salva ultimi 100 eventi
                lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                userEmail: user.email
              });
              
              setLastSync(new Date().toLocaleString('it-IT'));
              console.log('Salvato su Firebase');
            } catch (error) {
              setSyncError('Errore sincronizzazione Firebase');
              console.error('Errore sync:', error);
            } finally {
              setIsSyncing(false);
            }
          };

          // Carica da Firebase
          const loadFromFirebase = async () => {
            if (!user) return;
            
            setIsSyncing(true);
            setSyncError(null);
            
            try {
              const doc = await db.collection('users').doc(user.uid).get();
              
              if (doc.exists) {
                const firebaseData = doc.data();
                
                // Carica dati persistenti
                if (firebaseData.persistentData) {
                  setPersistentData(firebaseData.persistentData);
                  localStorage.setItem('debtPersistentData', JSON.stringify(firebaseData.persistentData));
                }
                
                // Carica dati Excel
                if (firebaseData.excelData) {
                  setData(firebaseData.excelData);
                  setFilteredData(firebaseData.excelData);
                  localStorage.setItem('debtExcelData', JSON.stringify(firebaseData.excelData));
                }
                
                // Carica altri dati
                if (firebaseData.currentFile) {
                  setCurrentFile(firebaseData.currentFile);
                  localStorage.setItem('currentFileName', firebaseData.currentFile);
                }
                
                if (firebaseData.history) {
                  setHistory(firebaseData.history);
                }
                
                setLastSync(new Date().toLocaleString('it-IT'));
                addHistoryEvent('Firebase Sync', 'Dati caricati dal cloud');
              } else {
                // Prima volta, carica dati locali se esistono
                loadLocalData();
              }
            } catch (error) {
              setSyncError('Errore caricamento da Firebase');
              console.error('Errore load:', error);
              // Fallback ai dati locali
              loadLocalData();
            } finally {
              setIsSyncing(false);
            }
          };

          // Carica dati locali
          const loadLocalData = () => {
            try {
              // Carica dati persistenti
              const savedPersistent = localStorage.getItem('debtPersistentData');
              if (savedPersistent) {
                setPersistentData(JSON.parse(savedPersistent));
              }
              
              // Carica dati Excel
              const savedExcelData = localStorage.getItem('debtExcelData');
              const savedFileName = localStorage.getItem('currentFileName');
              
              if (savedExcelData && savedFileName) {
                const parsedData = JSON.parse(savedExcelData);
                setData(parsedData);
                setFilteredData(parsedData);
                setCurrentFile(savedFileName);
              }
            } catch (error) {
              console.error('Errore caricamento dati locali:', error);
            }
          };

          // Salva dati localmente (backup)
          const saveLocalData = () => {
            try {
              localStorage.setItem('debtPersistentData', JSON.stringify(persistentData));
              localStorage.setItem('debtPersistentBackup', JSON.stringify({
                data: persistentData,
                excelData: data,
                currentFile,
                timestamp: new Date().toISOString()
              }));
              
              if (data.length > 0) {
                localStorage.setItem('debtExcelData', JSON.stringify(data));
              }
              if (currentFile) {
                localStorage.setItem('currentFileName', currentFile);
              }
              
              addHistoryEvent('Salvataggio', 'Dati salvati localmente');
            } catch (error) {
              console.error('Errore salvataggio locale:', error);
            }
          };

          // Ottieni dati persistenti per BDTI
          const getPersistentDataForBDTI = (bdti) => {
            return persistentData[bdti] || {
              affiliato: '',
              note: '',
              stato: '',
              contatti: {},
              dataPromessa: null,
              fonte: ''
            };
          };

          // Aggiorna dati persistenti per BDTI
          const updatePersistentData = (bdti, field, value) => {
            setPersistentData(prev => ({
              ...prev,
              [bdti]: {
                ...getPersistentDataForBDTI(bdti),
                [field]: value,
                lastModified: new Date().toISOString()
              }
            }));
            
            // Salva anche localmente
            saveLocalData();
          };

          // Controlla alert promesse
          const checkPromiseAlerts = () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let alertPromises = [];
            
            Object.entries(persistentData).forEach(([bdti, data]) => {
              if (data.stato === 'promessa' && data.dataPromessa) {
                const promiseDate = new Date(data.dataPromessa);
                promiseDate.setHours(0, 0, 0, 0);
                
                const diffDays = Math.floor((today - promiseDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0) {
                  const clientData = filteredData.find(item => item.bdti === bdti);
                  if (clientData) {
                    alertPromises.push({
                      bdti,
                      ragioneSociale: clientData.ragioneSociale,
                      giorniScaduti: diffDays
                    });
                  }
                }
              }
            });
            
            if (alertPromises.length > 0 && !sessionStorage.getItem('promiseAlertShown')) {
              alert(`⚠️ ATTENZIONE: ${alertPromises.length} promesse scadute!\n\n` +
                    alertPromises.map(p => `${p.ragioneSociale} - scaduta da ${p.giorniScaduti} giorni`).join('\n'));
              sessionStorage.setItem('promiseAlertShown', 'true');
            }
            
            return alertPromises;
          };

          // Gestione upload file Excel
          const handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data);
              const worksheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
              
              const formattedData = [];
              for (let i = 2; i < jsonData.length; i++) {
                if (jsonData[i][0]) {
                  const bdti = String(jsonData[i][3] || '');
                  const persistentInfo = getPersistentDataForBDTI(bdti);
                  
                  formattedData.push({
                    nomeConsulente: jsonData[i][0] || '',
                    nomeAreaManager: jsonData[i][1] || '',
                    nomeTeamManager: jsonData[i][2] || '',
                    bdti: bdti,
                    ragioneSociale: jsonData[i][4] || '',
                    documento: jsonData[i][5] || '',
                    dataDocumento: jsonData[i][6] || '',
                    dataScadenza: jsonData[i][7] || '',
                    debito: parseFloat(jsonData[i][8]) || 0,
                    codPagamento: jsonData[i][9] || '',
                    noteExcel: jsonData[i][10] || '',
                    // Dati persistenti recuperati
                    affiliato: persistentInfo.affiliato,
                    note: persistentInfo.note,
                    stato: persistentInfo.stato,
                    contatti: persistentInfo.contatti,
                    dataPromessa: persistentInfo.dataPromessa,
                    fonte: persistentInfo.fonte
                  });
                }
              }
              
              setData(formattedData);
              setFilteredData(formattedData);
              setCurrentFile(file.name);
              
              // Salva localmente
              saveLocalData();
              
              addHistoryEvent('File caricato', file.name);
              
              // Alert per promesse scadute
              checkPromiseAlerts();
              
              // Sync con Firebase se loggato
              if (user) {
                saveToFirebase();
              }
            };
            reader.readAsArrayBuffer(file);
          };

          // Funzione di ricerca
          const handleSearch = () => {
            let filtered = data;

            if (searchTerm) {
              const searchLower = searchTerm.toLowerCase();
              filtered = filtered.filter(item => {
                const persistent = getPersistentDataForBDTI(item.bdti);
                switch (searchType) {
                  case 'bdti':
                    return item.bdti.toLowerCase().includes(searchLower);
                  case 'ragioneSociale':
                    return item.ragioneSociale.toLowerCase().includes(searchLower);
                  case 'teamManager':
                    return item.nomeTeamManager.toLowerCase().includes(searchLower);
                  case 'affiliato':
                    return persistent.affiliato.toLowerCase().includes(searchLower);
                  default:
                    return false;
                }
              });
            }

            setFilteredData(filtered);
          };

          useEffect(() => {
            handleSearch();
          }, [searchTerm, searchType, data]);

          // Applica filtri per stato
          const applyStatusFilter = (status) => {
            setFilterStatus(status);
            
            if (status === 'all') {
              setFilteredData(data);
            } else {
              const filteredBdti = Object.keys(persistentData).filter(
                bdti => persistentData[bdti].stato === status
              );
              setFilteredData(data.filter(item => filteredBdti.includes(item.bdti)));
            }
          };

          // Export Excel
          const exportToExcel = (onlySuspended = false) => {
            const exportData = [];
            
            const tempGroupedData = data.reduce((acc, item) => {
              if (!acc[item.bdti]) {
                acc[item.bdti] = {
                  ...item,
                  documents: [],
                  totalDebt: 0
                };
              }
              acc[item.bdti].documents.push(item);
              acc[item.bdti].totalDebt += parseFloat(item.debito) || 0;
              return acc;
            }, {});
            
            Object.values(tempGroupedData).forEach(group => {
              const persistent = getPersistentDataForBDTI(group.bdti);
              
              if (onlySuspended && persistent.stato !== 'sospeso') return;
              
              group.documents.forEach(doc => {
                exportData.push({
                  'Nome Consulente': doc.nomeConsulente,
                  'Nome Area Manager': doc.nomeAreaManager,
                  'Nome Team Manager': doc.nomeTeamManager,
                  'BDTI': doc.bdti,
                  'Ragione Sociale': doc.ragioneSociale,
                  'Affiliato': persistent.affiliato || '',
                  'Documento': doc.documento,
                  'Data Documento': doc.dataDocumento,
                  'Data Scadenza': doc.dataScadenza,
                  'Debito': doc.debito,
                  'Cod Pagamento': doc.codPagamento,
                  'Stato': persistent.stato || 'non definito',
                  'Data Promessa': persistent.dataPromessa || '',
                  'WhatsApp': persistent.contatti?.whatsapp ? 'SI' : 'NO',
                  'Mail': persistent.contatti?.mail ? 'SI' : 'NO',
                  'Voce': persistent.contatti?.voce ? 'SI' : 'NO',
                  'Note': persistent.note || '',
                  'Fonte': persistent.fonte || ''
                });
              });
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Debiti');
            
            const fileName = onlySuspended 
              ? `sospesi_${new Date().toISOString().slice(0,10)}.xlsx`
              : `debiti_completo_${new Date().toISOString().slice(0,10)}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
            addHistoryEvent('Export Excel', onlySuspended ? 'Solo sospesi' : 'Completo');
          };

          // Backup locale
          const createBackup = () => {
            const backupData = {
              persistentData,
              excelData: data,
              currentFile,
              history,
              timestamp: new Date().toISOString(),
              user: user?.email
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `backup_debiti_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            addHistoryEvent('Backup', 'Backup completo creato');
          };

          // Import backup
          const importBackup = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const imported = JSON.parse(e.target.result);
                
                if (imported.persistentData) {
                  setPersistentData(imported.persistentData);
                  
                  if (imported.excelData) {
                    setData(imported.excelData);
                    setFilteredData(imported.excelData);
                  }
                  
                  if (imported.currentFile) {
                    setCurrentFile(imported.currentFile);
                  }
                  
                  if (imported.history) {
                    setHistory(imported.history);
                  }
                  
                  // Salva tutto
                  saveLocalData();
                  
                  // Sync con Firebase se loggato
                  if (user) {
                    saveToFirebase();
                  }
                  
                  alert('✅ Backup importato con successo!');
                  addHistoryEvent('Import', 'Backup importato');
                } else {
                  alert('❌ Formato backup non valido');
                }
              } catch (error) {
                alert('❌ Errore nell\'importazione del backup');
              }
            };
            reader.readAsText(file);
            e.target.value = '';
          };

          // Ripristina backup
          const restoreBackup = () => {
            if (!window.confirm('⚠️ Ripristinare l\'ultimo backup locale?\n\nI dati attuali verranno persi!')) {
              return;
            }

            try {
              const backup = localStorage.getItem('debtPersistentBackup');
              if (backup) {
                const parsed = JSON.parse(backup);
                setPersistentData(parsed.data);
                
                if (parsed.excelData) {
                  setData(parsed.excelData);
                  setFilteredData(parsed.excelData);
                }
                
                if (parsed.currentFile) {
                  setCurrentFile(parsed.currentFile);
                }
                
                alert('✅ Backup ripristinato!');
                addHistoryEvent('Ripristino', 'Backup locale ripristinato');
              } else {
                alert('❌ Nessun backup trovato');
              }
            } catch (error) {
              alert('❌ Errore nel ripristino');
            }
          };

          // Genera testo WhatsApp
          const generateWhatsAppText = (debtor) => {
            const allDocuments = data.filter(item => item.bdti === debtor.bdti);
            const totalDebt = allDocuments.reduce((sum, item) => sum + (parseFloat(item.debito) || 0), 0);
            const persistent = getPersistentDataForBDTI(debtor.bdti);
            
            const templates = {
              primo: {
                name: 'Primo Sollecito',
                text: () => {
                  let text = `Ciao per ${debtor.ragioneSociale} *Codice BDTI:* ${debtor.bdti}\n`;
                  text += `ti ricordo che risultano insolute le fatture :\n`;
                  allDocuments.forEach(doc => {
                    text += `• Doc. ${doc.documento} del ${doc.dataDocumento} - € ${doc.debito.toFixed(2)}\n`;
                  });
                  text += `*TOTALE: € ${totalDebt.toFixed(2)}*\n\n`;
                  text += `Resto a disposizione per qualsiasi chiarimento.\n`;
                  text += `Grazie e buon lavoro`;
                  return text;
                }
              },
              secondo: {
                name: 'Secondo Sollecito',
                text: () => {
                  let text = `Ciao l'amministrazione ti ha scritto in merito all'insoluto una mail con il dettaglio del dovuto\n`;
                  text += `*Cliente:* ${debtor.ragioneSociale}\n`;
                  text += `*Codice BDTI:* ${debtor.bdti}\n\n`;
                  text += `*Dettaglio documenti scaduti:*\n`;
                  allDocuments.forEach(doc => {
                    text += `• Doc. ${doc.documento} del ${doc.dataDocumento} - € ${doc.debito.toFixed(2)}\n`;
                  });
                  text += `*TOTALE DEBITO: € ${totalDebt.toFixed(2)}*\n`;
                  text += `Mi fai sapere come regolarci per il saldo!! Se non mi dai riscontro a breve scatta la sospensione definitiva. Grazie e buon lavoro.`;
                  return text;
                }
              },
              conferma: {
                name: 'Conferma Pagamento',
                text: () => {
                  let text = `Grazie per ${debtor.ragioneSociale} *Codice BDTI:* ${debtor.bdti},\n`;
                  text += `Abbiamo ricevuto il pagamento.\n`;
                  text += `Buon lavoro`;
                  return text;
                }
              }
            };
            
            return templates[selectedTemplate].text();
          };

          // Copia testo WhatsApp
          const copyToClipboard = (debtor) => {
            const text = generateWhatsAppText(debtor);
            navigator.clipboard.writeText(text).then(() => {
              setCopied(true);
              setSelectedDebtor(debtor.bdti);
              addHistoryEvent('Messaggio copiato', `BDTI ${debtor.bdti}`);
              setTimeout(() => {
                setCopied(false);
                setSelectedDebtor(null);
              }, 2000);
            });
          };

          // Aggiungi evento allo storico
          const addHistoryEvent = (action, details) => {
            const event = {
              timestamp: new Date().toLocaleString('it-IT'),
              action,
              details,
              user: user?.email || 'Locale'
            };
            setHistory(prev => [event, ...prev].slice(0, 50));
          };

          // Calcola statistiche
          const getStats = () => {
            const totalDebt = data.reduce((sum, item) => sum + (parseFloat(item.debito) || 0), 0);
            
            const uniqueBdti = [...new Set(data.map(item => item.bdti))];
            const counts = {
              totale: uniqueBdti.length,
              pagato: 0,
              promessa: 0,
              sospeso: 0,
              attivi: 0
            };
            
            uniqueBdti.forEach(bdti => {
              const stato = persistentData[bdti]?.stato;
              if (stato === 'pagato') counts.pagato++;
              else if (stato === 'promessa') counts.promessa++;
              else if (stato === 'sospeso') counts.sospeso++;
              
              if (stato === 'pagato' || stato === 'promessa') counts.attivi++;
            });
            
            return { totalDebt, counts };
          };

          // Ottieni promesse scadute
          const getOverduePromises = () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            return Object.entries(persistentData)
              .filter(([bdti, data]) => {
                if (data.stato !== 'promessa' || !data.dataPromessa) return false;
                const promiseDate = new Date(data.dataPromessa);
                promiseDate.setHours(0, 0, 0, 0);
                return promiseDate < today;
              })
              .map(([bdti, data]) => {
                const clientData = filteredData.find(item => item.bdti === bdti);
                const promiseDate = new Date(data.dataPromessa);
                const diffDays = Math.floor((today - promiseDate) / (1000 * 60 * 60 * 24));
                
                return {
                  bdti,
                  ragioneSociale: clientData?.ragioneSociale || 'N/D',
                  dataPromessa: data.dataPromessa,
                  giorniScaduti: diffDays,
                  affiliato: data.affiliato
                };
              })
              .sort((a, b) => b.giorniScaduti - a.giorniScaduti);
          };

          // Componenti Modal (Dashboard, Calendar, etc.)
          const Dashboard = () => {
            const stats = getStats();
            const topDebtors = Object.values(groupedData)
              .sort((a, b) => b.totalDebt - a.totalDebt)
              .slice(0, 10);

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="mac-card max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-semibold flex items-center gap-2">
                      <span>📊</span>
                      Dashboard Statistiche
                    </h2>
                    <button 
                      onClick={() => setShowDashboard(false)} 
                      className="text-gray-500 hover:text-gray-700"
                    >
                      ✕
                    </button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div className="glass rounded-lg p-4">
                      <h3 className="text-sm text-gray-600 mb-1">Totale Debiti</h3>
                      <p className="text-2xl font-bold text-blue-600">
                        € {stats.totalDebt.toFixed(2)}
                      </p>
                    </div>
                    <div className="glass rounded-lg p-4">
                      <h3 className="text-sm text-gray-600 mb-1">Clienti Attivi</h3>
                      <p className="text-2xl font-bold text-green-600">
                        {stats.counts.attivi}
                      </p>
                    </div>
                    <div className="glass rounded-lg p-4">
                      <h3 className="text-sm text-gray-600 mb-1">Clienti Sospesi</h3>
                      <p className="text-2xl font-bold text-red-600">
                        {stats.counts.sospeso}
                      </p>
                    </div>
                  </div>

                  <div className="glass rounded-lg p-4">
                    <h3 className="font-semibold mb-4">Top 10 Debitori</h3>
                    <div className="space-y-2">
                      {topDebtors.map((debtor, idx) => (
                        <div key={debtor.bdti} className="flex justify-between items-center p-2 hover:bg-gray-50 rounded">
                          <span className="flex items-center gap-2">
                            <span className="text-gray-500 font-medium">{idx + 1}.</span>
                            {debtor.ragioneSociale}
                          </span>
                          <span className="font-semibold text-red-600">
                            € {debtor.totalDebt.toFixed(2)}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          const PromisesView = () => {
            const overduePromises = getOverduePromises();
            const upcomingPromises = Object.entries(persistentData)
              .filter(([bdti, data]) => {
                if (data.stato !== 'promessa' || !data.dataPromessa) return false;
                const promiseDate = new Date(data.dataPromessa);
                const today = new Date();
                return promiseDate >= today;
              })
              .map(([bdti, data]) => {
                const clientData = filteredData.find(item => item.bdti === bdti);
                return {
                  bdti,
                  ragioneSociale: clientData?.ragioneSociale || 'N/D',
                  dataPromessa: data.dataPromessa,
                  affiliato: data.affiliato
                };
              })
              .sort((a, b) => new Date(a.dataPromessa) - new Date(b.dataPromessa));

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="mac-card max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-semibold flex items-center gap-2">
                      <span>🤝</span>
                      Riepilogo Promesse
                    </h2>
                    <button 
                      onClick={() => setShowPromises(false)} 
                      className="text-gray-500 hover:text-gray-700"
                    >
                      ✕
                    </button>
                  </div>

                  {overduePromises.length > 0 && (
                    <div className="mb-6">
                      <h3 className="font-semibold text-red-600 mb-4 flex items-center gap-2">
                        <span>⚠️</span>
                        Promesse Scadute ({overduePromises.length})
                      </h3>
                      <div className="space-y-2">
                        {overduePromises.map((promise) => (
                          <div key={promise.bdti} className="glass rounded-lg p-3 border-l-4 border-red-500">
                            <div className="flex justify-between items-start">
                              <div>
                                <p className="font-semibold">{promise.ragioneSociale}</p>
                                <p className="text-sm text-gray-600">
                                  BDTI: {promise.bdti} {promise.affiliato && `• Affiliato: ${promise.affiliato}`}
                                </p>
                              </div>
                              <div className="text-right">
                                <p className="text-sm text-gray-600">
                                  Promessa: {new Date(promise.dataPromessa).toLocaleDateString('it-IT')}
                                </p>
                                <p className="text-sm font-semibold text-red-600">
                                  Scaduta da {promise.giorniScaduti} giorni
                                </p>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {upcomingPromises.length > 0 && (
                    <div>
                      <h3 className="font-semibold text-blue-600 mb-4 flex items-center gap-2">
                        <span>📅</span>
                        Promesse Future ({upcomingPromises.length})
                      </h3>
                      <div className="space-y-2">
                        {upcomingPromises.map((promise) => (
                          <div key={promise.bdti} className="glass rounded-lg p-3 border-l-4 border-blue-500">
                            <div className="flex justify-between items-start">
                              <div>
                                <p className="font-semibold">{promise.ragioneSociale}</p>
                                <p className="text-sm text-gray-600">
                                  BDTI: {promise.bdti} {promise.affiliato && `• Affiliato: ${promise.affiliato}`}
                                </p>
                              </div>
                              <div className="text-right">
                                <p className="text-sm font-semibold text-blue-600">
                                  {new Date(promise.dataPromessa).toLocaleDateString('it-IT')}
                                </p>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {overduePromises.length === 0 && upcomingPromises.length === 0 && (
                    <p className="text-center text-gray-500">Nessuna promessa registrata</p>
                  )}
                </div>
              </div>
            );
          };

          const CalendarView = () => {
            const overdueDebts = data.filter(item => {
              const dueDate = new Date(item.dataScadenza);
              const today = new Date();
              return dueDate < today;
            }).sort((a, b) => new Date(b.dataScadenza) - new Date(a.dataScadenza));

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="mac-card max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-semibold flex items-center gap-2">
                      <span>📅</span>
                      Scadenzario
                    </h2>
                    <button 
                      onClick={() => setShowCalendar(false)} 
                      className="text-gray-500 hover:text-gray-700"
                    >
                      ✕
                    </button>
                  </div>

                  <div className="space-y-2">
                    {overdueDebts.map((debt, idx) => {
                      const dueDate = new Date(debt.dataScadenza);
                      const today = new Date();
                      const diffDays = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                      
                      return (
                        <div key={idx} className="glass rounded-lg p-3">
                          <div className="flex justify-between items-center">
                            <div>
                              <p className="font-semibold">{debt.ragioneSociale}</p>
                              <p className="text-sm text-gray-600">
                                Doc. {debt.documento} - BDTI: {debt.bdti}
                              </p>
                            </div>
                            <div className="text-right">
                              <p className="font-bold text-red-600">€ {debt.debito.toFixed(2)}</p>
                              <p className="text-sm text-red-500">
                                Scaduto da {diffDays} giorni
                              </p>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            );
          };

          const HistoryView = () => {
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="mac-card max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-semibold flex items-center gap-2">
                      <span>🕐</span>
                      Storico Azioni
                    </h2>
                    <button 
                      onClick={() => setShowHistory(false)} 
                      className="text-gray-500 hover:text-gray-700"
                    >
                      ✕
                    </button>
                  </div>

                  <div className="space-y-2">
                    {history.map((event, idx) => (
                      <div key={idx} className="glass rounded-lg p-3">
                        <div className="flex justify-between items-center">
                          <div>
                            <p className="font-semibold">{event.action}</p>
                            <p className="text-sm text-gray-600">{event.details}</p>
                          </div>
                          <div className="text-right">
                            <p className="text-sm text-gray-500">{event.timestamp}</p>
                            <p className="text-xs text-gray-400">{event.user}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                    {history.length === 0 && (
                      <p className="text-center text-gray-500">Nessuna azione registrata</p>
                    )}
                  </div>
                </div>
              </div>
            );
          };

          // Raggruppa i dati
          const groupedData = filteredData.reduce((acc, item) => {
            if (!acc[item.bdti]) {
              acc[item.bdti] = {
                ...item,
                documents: [],
                totalDebt: 0
              };
            }
            acc[item.bdti].documents.push(item);
            acc[item.bdti].totalDebt += parseFloat(item.debito) || 0;
            return acc;
          }, {});

          // Raggruppa per affiliato o team manager se richiesto
          let displayData = groupedData;
          if (groupBy === 'affiliato') {
            displayData = {};
            Object.values(groupedData).forEach(group => {
              const persistent = getPersistentDataForBDTI(group.bdti);
              const key = persistent.affiliato || 'Senza Affiliato';
              if (!displayData[key]) {
                displayData[key] = {
                  isGroup: true,
                  groupName: key,
                  items: []
                };
              }
              displayData[key].items.push(group);
            });
          } else if (groupBy === 'teamManager') {
            displayData = {};
            Object.values(groupedData).forEach(group => {
              const key = group.nomeTeamManager || 'Senza Team Manager';
              if (!displayData[key]) {
                displayData[key] = {
                  isGroup: true,
                  groupName: key,
                  items: []
                };
              }
              displayData[key].items.push(group);
            });
          }

          const stats = getStats();
          const overduePromisesCount = getOverduePromises().length;

          return (
            <div className="min-h-screen bg-gray-50">
              {/* Banner installazione app per iPad */}
              {!isStandalone && /iPad|iPhone|iPod/.test(navigator.userAgent) && (
                <div className="bg-blue-600 text-white p-3 text-center text-sm">
                  <p>📱 Installa come app: tocca <span className="font-bold">Condividi</span> → <span className="font-bold">Aggiungi a Home</span></p>
                </div>
              )}
              
              <div className="max-w-7xl mx-auto p-4">
                {/* Header */}
                <div className="mac-card p-6 mb-6">
                  <div className="flex justify-between items-center mb-4">
                    <h1 className="text-3xl font-bold text-gray-800">
                      GestDebit Pro
                    </h1>
                    <div className="flex items-center gap-4">
                      {/* Firebase Status */}
                      <div className="flex items-center gap-2">
                        {isOnline ? (
                          <span className="text-green-500">●</span>
                        ) : (
                          <span className="text-red-500">●</span>
                        )}
                        <span className="text-sm text-gray-600">
                          {isOnline ? 'Online' : 'Offline'}
                        </span>
                      </div>
                      
                      {/* User Status */}
                      {user ? (
                        <div className="flex items-center gap-2">
                          <span className="text-sm text-gray-600">🔥 {user.email}</span>
                          <button
                            onClick={() => {
                              auth.signOut();
                              addHistoryEvent('Logout', 'Disconnesso da Firebase');
                            }}
                            className="text-red-500 hover:text-red-700 text-sm"
                          >
                            Esci
                          </button>
                        </div>
                      ) : (
                        <button
                          onClick={() => setShowLogin(true)}
                          className="flex items-center gap-2 text-blue-600 hover:text-blue-800"
                        >
                          <span>🔥</span>
                          <span>Accedi</span>
                        </button>
                      )}
                      
                      {/* Autosave indicator */}
                      <div className="flex items-center gap-2">
                        <span className="text-sm text-gray-600">Autosalvataggio:</span>
                        <button
                          onClick={() => setAutoSave(!autoSave)}
                          className={`px-3 py-1 rounded-full text-sm font-medium ${
                            autoSave 
                              ? 'bg-green-500 text-white' 
                              : 'bg-gray-300 text-gray-700'
                          }`}
                        >
                          {autoSave ? 'ON' : 'OFF'}
                        </button>
                      </div>
                      
                      {/* Action buttons */}
                      <div className="flex gap-2">
                        <div className="tooltip">
                          <button
                            onClick={() => setShowDashboard(true)}
                            className="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                          >
                            <span>📊</span>
                          </button>
                          <span className="tooltiptext">Dashboard statistiche</span>
                        </div>
                        <div className="tooltip">
                          <button
                            onClick={() => setShowPromises(true)}
                            className="relative p-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 min-w-[44px] min-h-[44px]"
                          >
                            <span>🤝</span>
                            {overduePromisesCount > 0 && (
                              <span className="badge absolute -top-2 -right-2">
                                {overduePromisesCount}
                              </span>
                            )}
                          </button>
                          <span className="tooltiptext">Riepilogo promesse</span>
                        </div>
                        <div className="tooltip">
                          <button
                            onClick={() => setShowCalendar(true)}
                            className="p-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
                          >
                            <span>📅</span>
                          </button>
                          <span className="tooltiptext">Calendario scadenze</span>
                        </div>
                        <div className="tooltip">
                          <button
                            onClick={() => setShowHistory(true)}
                            className="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                          >
                            <span>🕐</span>
                          </button>
                          <span className="tooltiptext">Storico azioni</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* File Management */}
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center flex-wrap gap-2">
                        <div className="tooltip">
                          <label className="flex items-center gap-2 mac-button rounded-lg px-4 py-2 cursor-pointer">
                            <span>📤</span>
                            <span>Carica Excel</span>
                            <input
                              type="file"
                              accept=".xlsx,.xls"
                              onChange={handleFileUpload}
                              className="hidden"
                            />
                          </label>
                          <span className="tooltiptext">Carica file Excel</span>
                        </div>
                        
                        {currentFile && (
                          <>
                            <div className="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded-lg">
                              <span>📄</span>
                              <span className="text-sm">{currentFile}</span>
                            </div>
                            
                            <div className="tooltip">
                              <button
                                onClick={() => {
                                  if (window.confirm('⚠️ Eliminare tutti i dati Excel?\n\nI dati salvati (note, stati, affiliati) verranno mantenuti.')) {
                                    setData([]);
                                    setFilteredData([]);
                                    setCurrentFile(null);
                                    
                                    // Rimuovi dal localStorage
                                    localStorage.removeItem('debtExcelData');
                                    localStorage.removeItem('currentFileName');
                                    
                                    addHistoryEvent('Dati eliminati', 'Dati Excel eliminati');
                                    
                                    // Salva su Firebase
                                    if (user) {
                                      saveToFirebase();
                                    }
                                  }
                                }}
                                className="flex items-center gap-2 mac-button rounded-lg px-4 py-2 text-red-600"
                              >
                                <span>🗑️</span>
                                <span>Elimina Excel</span>
                              </button>
                              <span className="tooltiptext">Elimina dati Excel</span>
                            </div>
                          </>
                        )}
                        
                        {/* Firebase Sync Buttons */}
                        {user && (
                          <>
                            <div className="tooltip">
                              <button
                                onClick={saveToFirebase}
                                disabled={isSyncing || !isOnline}
                                className="flex items-center gap-2 mac-button rounded-lg px-4 py-2 disabled:opacity-50"
                              >
                                <span>☁️</span>
                                <span>{isSyncing ? 'Sync...' : 'Salva Cloud'}</span>
                              </button>
                              <span className="tooltiptext">Salva su Firebase</span>
                            </div>
                            
                            <div className="tooltip">
                              <button
                                onClick={loadFromFirebase}
                                disabled={isSyncing || !isOnline}
                                className="flex items-center gap-2 mac-button rounded-lg px-4 py-2 disabled:opacity-50"
                              >
                                <span>📥</span>
                                <span>Carica Cloud</span>
                              </button>
                              <span className="tooltiptext">Carica da Firebase</span>
                            </div>
                          </>
                        )}
                        
                        <div className="tooltip">
                          <button
                            onClick={createBackup}
                            className="flex items-center gap-2 mac-button rounded-lg px-4 py-2"
                          >
                            <span>🛡️</span>
                            <span>Backup</span>
                          </button>
                          <span className="tooltiptext">Crea backup locale</span>
                        </div>
                        
                        <div className="tooltip">
                          <label className="flex items-center gap-2 mac-button rounded-lg px-4 py-2 cursor-pointer">
                            <span>📄</span>
                            <span>Importa</span>
                            <input
                              type="file"
                              accept=".json"
                              onChange={importBackup}
                              className="hidden"
                            />
                          </label>
                          <span className="tooltiptext">Importa backup</span>
                        </div>
                        
                        <div className="tooltip">
                          <button
                            onClick={restoreBackup}
                            className="flex items-center gap-2 mac-button rounded-lg px-4 py-2"
                          >
                            <span>🔄</span>
                            <span>Ripristina</span>
                          </button>
                          <span className="tooltiptext">Ripristina ultimo backup</span>
                        </div>
                      </div>
                    </div>

                    {/* Info sincronizzazione */}
                    <div className="flex items-center justify-between text-sm text-gray-600">
                      <div className="flex items-center gap-4">
                        {lastSync && (
                          <span>Ultima sincronizzazione: {lastSync}</span>
                        )}
                        <span className="font-semibold">
                          Dati locali: {localDataCount} clienti
                        </span>
                      </div>
                      {syncError && (
                        <div className="flex items-center gap-2 text-red-600">
                          <span>⚠️</span>
                          <span>{syncError}</span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Filtri e Ricerca */}
                <div className="mac-card p-4 mb-6">
                  <div className="space-y-4">
                    {/* Filtri stato */}
                    <div className="flex items-center gap-4 flex-wrap">
                      <span className="font-semibold">Mostra:</span>
                      <div className="flex gap-2">
                        <button
                          onClick={() => applyStatusFilter('all')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            filterStatus === 'all' 
                              ? 'bg-blue-500 text-white' 
                              : 'mac-button'
                          }`}
                        >
                          Tutti ({stats.counts.totale})
                        </button>
                        <button
                          onClick={() => applyStatusFilter('pagato')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            filterStatus === 'pagato' 
                              ? 'bg-green-500 text-white' 
                              : 'mac-button text-green-600'
                          }`}
                        >
                          Pagati ({stats.counts.pagato})
                        </button>
                        <button
                          onClick={() => applyStatusFilter('promessa')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            filterStatus === 'promessa' 
                              ? 'bg-yellow-500 text-white' 
                              : 'mac-button text-yellow-600'
                          }`}
                        >
                          Promesse ({stats.counts.promessa})
                        </button>
                        <button
                          onClick={() => applyStatusFilter('sospeso')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            filterStatus === 'sospeso' 
                              ? 'bg-red-500 text-white' 
                              : 'mac-button text-red-600'
                          }`}
                        >
                          Sospesi ({stats.counts.sospeso})
                        </button>
                      </div>
                    </div>

                    {/* Raggruppamento */}
                    <div className="flex items-center gap-4 flex-wrap">
                      <span className="font-semibold">Raggruppa per:</span>
                      <div className="flex gap-2">
                        <button
                          onClick={() => setGroupBy('none')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            groupBy === 'none' 
                              ? 'bg-gray-600 text-white' 
                              : 'mac-button'
                          }`}
                        >
                          Nessuno
                        </button>
                        <button
                          onClick={() => setGroupBy('affiliato')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            groupBy === 'affiliato' 
                              ? 'bg-purple-600 text-white' 
                              : 'mac-button'
                          }`}
                        >
                          Affiliato
                        </button>
                        <button
                          onClick={() => setGroupBy('teamManager')}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            groupBy === 'teamManager' 
                              ? 'bg-indigo-600 text-white' 
                              : 'mac-button'
                          }`}
                        >
                          Team Manager
                        </button>
                      </div>
                    </div>

                    {/* Barra di ricerca */}
                    <div className="flex gap-4 flex-wrap">
                      <select
                        value={searchType}
                        onChange={(e) => setSearchType(e.target.value)}
                        className="mac-input mac-select rounded-lg px-4 py-2"
                      >
                        <option value="ragioneSociale">Ragione Sociale</option>
                        <option value="bdti">BDTI</option>
                        <option value="teamManager">Team Manager</option>
                        <option value="affiliato">Affiliato</option>
                      </select>
                      
                      <div className="flex-1 relative min-w-[200px]">
                        <input
                          type="text"
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                          placeholder="Cerca..."
                          className="w-full mac-input rounded-lg px-4 py-2 pr-10"
                        />
                        <span className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                          🔍
                        </span>
                      </div>

                      <select
                        value={selectedTemplate}
                        onChange={(e) => setSelectedTemplate(e.target.value)}
                        className="mac-input mac-select rounded-lg px-4 py-2"
                      >
                        <option value="primo">Primo Sollecito</option>
                        <option value="secondo">Secondo Sollecito</option>
                        <option value="conferma">Conferma Pagamento</option>
                      </select>

                      {/* Export buttons */}
                      {data.length > 0 && (
                        <div className="flex gap-2">
                          <div className="tooltip">
                            <button
                              onClick={() => exportToExcel(false)}
                              className="flex items-center gap-2 mac-button rounded-lg px-4 py-2"
                            >
                              <span>📥</span>
                              <span>Excel</span>
                            </button>
                            <span className="tooltiptext">Export Excel completo</span>
                          </div>
                          <div className="tooltip">
                            <button
                              onClick={() => exportToExcel(true)}
                              className="flex items-center gap-2 mac-button rounded-lg px-4 py-2"
                            >
                              <span>📥</span>
                              <span>Sospesi</span>
                            </button>
                            <span className="tooltiptext">Export solo sospesi</span>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Archivio Note */}
                {showAllNotes && (
                  <div className="mac-card p-6 mb-6">
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-semibold">📝 Archivio Note</h2>
                      <button
                        onClick={() => setShowAllNotes(false)}
                        className="text-gray-500 hover:text-gray-700"
                      >
                        ✕
                      </button>
                    </div>
                    <div className="space-y-3">
                      {Object.entries(persistentData)
                        .filter(([_, data]) => data.note)
                        .map(([bdti, data]) => {
                          const clientData = filteredData.find(item => item.bdti === bdti);
                          return (
                            <div key={bdti} className="glass rounded-lg p-4">
                              <div className="flex justify-between items-start mb-2">
                                <div>
                                  <span className="font-semibold">BDTI: {bdti}</span>
                                  {clientData && (
                                    <span className="ml-2 text-sm text-gray-600">
                                      - {clientData.ragioneSociale}
                                    </span>
                                  )}
                                  {data.affiliato && (
                                    <span className="ml-2 text-sm text-purple-600">
                                      • {data.affiliato}
                                    </span>
                                  )}
                                </div>
                                <span className="text-xs text-gray-500">
                                  {new Date(data.lastModified).toLocaleString('it-IT')}
                                </span>
                              </div>
                              <p className="text-gray-700 whitespace-pre-wrap">{data.note}</p>
                            </div>
                          );
                        })}
                    </div>
                  </div>
                )}

                {/* Results */}
                {Object.keys(displayData).length > 0 ? (
                  <div className="space-y-4">
                    {/* Visualizzazione raggruppata */}
                    {groupBy !== 'none' ? (
                      Object.entries(displayData).map(([groupKey, groupData]) => (
                        <div key={groupKey} className="space-y-4">
                          <h3 className="text-lg font-semibold text-gray-700 bg-gray-100 px-4 py-2 rounded-lg">
                            {groupData.groupName} ({groupData.items.length})
                          </h3>
                          {groupData.items.map((group) => (
                            <DebtorCard 
                              key={group.bdti} 
                              group={group} 
                              persistentData={persistentData}
                              getPersistentDataForBDTI={getPersistentDataForBDTI}
                              updatePersistentData={updatePersistentData}
                              handleStateChange={(bdti, state) => {
                                updatePersistentData(bdti, 'stato', state);
                                if (state !== 'promessa') {
                                  updatePersistentData(bdti, 'dataPromessa', null);
                                }
                                // Salva su Firebase se loggato
                                if (user) {
                                  setTimeout(() => saveToFirebase(), 500);
                                }
                              }}
                              handleContactMethodChange={(bdti, method, checked) => {
                                const current = getPersistentDataForBDTI(bdti);
                                updatePersistentData(bdti, 'contatti', {
                                  ...current.contatti,
                                  [method]: checked
                                });
                              }}
                              copyToClipboard={copyToClipboard}
                              selectedDebtor={selectedDebtor}
                              copied={copied}
                            />
                          ))}
                        </div>
                      ))
                    ) : (
                      // Visualizzazione normale
                      Object.values(displayData).map((group) => (
                        <DebtorCard 
                          key={group.bdti} 
                          group={group} 
                          persistentData={persistentData}
                          getPersistentDataForBDTI={getPersistentDataForBDTI}
                          updatePersistentData={updatePersistentData}
                          handleStateChange={(bdti, state) => {
                            updatePersistentData(bdti, 'stato', state);
                            if (state !== 'promessa') {
                              updatePersistentData(bdti, 'dataPromessa', null);
                            }
                            // Salva su Firebase se loggato
                            if (user) {
                              setTimeout(() => saveToFirebase(), 500);
                            }
                          }}
                          handleContactMethodChange={(bdti, method, checked) => {
                            const current = getPersistentDataForBDTI(bdti);
                            updatePersistentData(bdti, 'contatti', {
                              ...current.contatti,
                              [method]: checked
                            });
                          }}
                          copyToClipboard={copyToClipboard}
                          selectedDebtor={selectedDebtor}
                          copied={copied}
                        />
                      ))
                    )}
                  </div>
                ) : (
                  <div className="mac-card p-12 text-center">
                    <p className="text-gray-500 text-lg">
                      {data.length === 0 
                        ? 'Carica un file Excel per iniziare'
                        : 'Nessun risultato trovato'}
                    </p>
                  </div>
                )}

                {/* Link archivio */}
                {!showAllNotes && Object.keys(persistentData).some(bdti => persistentData[bdti].note) && (
                  <div className="text-center mt-6">
                    <button
                      onClick={() => setShowAllNotes(true)}
                      className="text-blue-600 hover:text-blue-800 underline"
                    >
                      Vedi archivio note ({Object.keys(persistentData).filter(bdti => persistentData[bdti].note).length})
                    </button>
                  </div>
                )}
              </div>

              {/* Modals */}
              {showDashboard && <Dashboard />}
              {showPromises && <PromisesView />}
              {showCalendar && <CalendarView />}
              {showHistory && <HistoryView />}
              {showLogin && <LoginForm onClose={() => setShowLogin(false)} />}
            </div>
          );
        };

        // Componente Card Debitore
        const DebtorCard = ({ 
          group, 
          persistentData,
          getPersistentDataForBDTI,
          updatePersistentData,
          handleStateChange,
          handleContactMethodChange,
          copyToClipboard,
          selectedDebtor,
          copied
        }) => {
          const persistent = getPersistentDataForBDTI(group.bdti);
          const state = persistent.stato;
          
          const stateColors = {
            pagato: 'border-green-500 bg-green-50',
            promessa: 'border-yellow-500 bg-yellow-50',
            sospeso: 'border-red-500 bg-red-50'
          };
          
          return (
            <div className={`mac-card p-6 border-2 ${stateColors[state] || 'border-gray-200'}`}>
              <div className="flex justify-between items-start mb-4">
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-2">
                    <h2 className="text-xl font-semibold text-gray-800">
                      {group.ragioneSociale}
                    </h2>
                    {persistent.note && (
                      <span title="Nota presente">📝</span>
                    )}
                  </div>
                  <div className="space-y-1 text-sm text-gray-600">
                    <p>BDTI: {group.bdti}</p>
                    <p>Team Manager: {group.nomeTeamManager}</p>
                    <div className="flex items-center gap-2">
                      <span>Affiliato:</span>
                      <input
                        type="text"
                        value={persistent.affiliato || ''}
                        onChange={(e) => updatePersistentData(group.bdti, 'affiliato', e.target.value)}
                        placeholder="Inserisci affiliato..."
                        className="mac-input rounded px-2 py-1 text-sm"
                      />
                    </div>
                  </div>
                </div>
                
                <div className="text-right">
                  <p className="text-2xl font-bold text-red-600">
                    € {group.totalDebt.toFixed(2)}
                  </p>
                  
                  {/* Pulsanti per stato */}
                  <div className="mt-3 flex gap-1">
                    <button
                      onClick={() => handleStateChange(group.bdti, state === 'pagato' ? '' : 'pagato')}
                      className={`flex-1 px-2 py-3 rounded-lg text-xs font-bold transition-all min-h-[44px] ${
                        state === 'pagato'
                          ? 'bg-green-500 text-white border-2 border-green-600 shadow-md'
                          : 'bg-white text-green-600 border border-green-500 hover:bg-green-50'
                      }`}
                    >
                      ATTIVO PAGATO
                    </button>
                    
                    <button
                      onClick={() => handleStateChange(group.bdti, state === 'promessa' ? '' : 'promessa')}
                      className={`flex-1 px-2 py-3 rounded-lg text-xs font-bold transition-all min-h-[44px] ${
                        state === 'promessa'
                          ? 'bg-yellow-500 text-white border-2 border-yellow-600 shadow-md'
                          : 'bg-white text-yellow-600 border border-yellow-500 hover:bg-yellow-50'
                      }`}
                    >
                      ATTIVO PROMESSA
                    </button>
                    
                    <button
                      onClick={() => handleStateChange(group.bdti, state === 'sospeso' ? '' : 'sospeso')}
                      className={`flex-1 px-2 py-3 rounded-lg text-xs font-bold transition-all min-h-[44px] ${
                        state === 'sospeso'
                          ? 'bg-red-500 text-white border-2 border-red-600 shadow-md'
                          : 'bg-white text-red-600 border border-red-500 hover:bg-red-50'
                      }`}
                    >
                      SOSPESO
                    </button>
                  </div>
                  
                  {state === 'promessa' && (
                    <div className="mt-2">
                      <input
                        type="date"
                        value={persistent.dataPromessa || ''}
                        onChange={(e) => updatePersistentData(group.bdti, 'dataPromessa', e.target.value)}
                        className="mac-input rounded px-2 py-1 text-sm w-full"
                        min={new Date().toISOString().split('T')[0]}
                      />
                    </div>
                  )}
                  
                  <button
                    onClick={() => copyToClipboard(group)}
                    className={`mt-2 flex items-center gap-2 px-4 py-2 rounded-lg w-full justify-center ${
                      selectedDebtor === group.bdti && copied
                        ? 'bg-green-500 text-white'
                        : 'mac-button'
                    }`}
                  >
                    {selectedDebtor === group.bdti && copied ? (
                      <>
                        <span>✅</span>
                        <span>Copiato!</span>
                      </>
                    ) : (
                      <>
                        <span>📋</span>
                        <span>Copia WhatsApp</span>
                      </>
                    )}
                  </button>
                </div>
              </div>
              
              <div className="border-t pt-4">
                <h3 className="font-semibold text-gray-700 mb-2">Documenti:</h3>
                <div className="space-y-1 text-sm">
                  {group.documents.map((doc, idx) => (
                    <div key={idx} className="flex justify-between text-gray-600">
                      <span>Doc. {doc.documento} del {doc.dataDocumento}</span>
                      <span className="font-medium">€ {doc.debito.toFixed(2)}</span>
                    </div>
                  ))}
                </div>
                
                <div className="mt-4">
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-semibold text-gray-700">Note / Risposta cliente:</h3>
                    <div className="flex items-center gap-3">
                      <label className="flex items-center gap-1 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={persistent.contatti?.whatsapp || false}
                          onChange={(e) => handleContactMethodChange(group.bdti, 'whatsapp', e.target.checked)}
                          className="rounded"
                        />
                        <span>💬</span>
                        <span className="text-sm">WhatsApp</span>
                      </label>
                      <label className="flex items-center gap-1 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={persistent.contatti?.mail || false}
                          onChange={(e) => handleContactMethodChange(group.bdti, 'mail', e.target.checked)}
                          className="rounded"
                        />
                        <span>✉️</span>
                        <span className="text-sm">Mail</span>
                      </label>
                      <label className="flex items-center gap-1 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={persistent.contatti?.voce || false}
                          onChange={(e) => handleContactMethodChange(group.bdti, 'voce', e.target.checked)}
                          className="rounded"
                        />
                        <span>📞</span>
                        <span className="text-sm">Voce</span>
                      </label>
                    </div>
                  </div>
                  <textarea
                    value={persistent.note || ''}
                    onChange={(e) => updatePersistentData(group.bdti, 'note', e.target.value)}
                    placeholder="Inserisci qui la risposta del cliente..."
                    className="w-full mac-input rounded-lg p-3 resize-none"
                    rows="3"
                  />
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DebtManagementApp />);
    </script>
</body>
</html>
